{% extends "base.html" %} {% block title %}Đổi mật khẩu - SmartRent{% endblock
%} {% block extra_css %}
<style>
  .password-strength {
    height: 5px;
    border-radius: 3px;
    margin-top: 5px;
    transition: all 0.3s ease;
  }
  .strength-weak {
    background: linear-gradient(90deg, #dc3545 0%, #dc3545 33%, #e9ecef 33%);
  }
  .strength-medium {
    background: linear-gradient(90deg, #ffc107 0%, #ffc107 66%, #e9ecef 66%);
  }
  .strength-strong {
    background: linear-gradient(90deg, #28a745 0%, #28a745 100%);
  }
  .password-requirements {
    font-size: 0.875rem;
  }
  .requirement {
    transition: all 0.3s ease;
  }
  .requirement.met {
    color: #28a745;
  }
  .requirement.met i::before {
    content: "\f00c";
  }
</style>
{% endblock %} {% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-warning text-white">
          <h4><i class="fas fa-key"></i> Đổi mật khẩu</h4>
        </div>
        <div class="card-body">
          <form
            method="POST"
            action="{{ url_for('auth.change_password') }}"
            id="changePasswordForm"
          >
            <div class="mb-3">
              <label for="old_password" class="form-label"
                >Mật khẩu cũ <span class="text-danger">*</span></label
              >
              <div class="input-group">
                <input
                  type="password"
                  class="form-control"
                  id="old_password"
                  name="old_password"
                  required
                />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  onclick="togglePassword('old_password')"
                >
                  <i class="fas fa-eye" id="old_password_icon"></i>
                </button>
              </div>
            </div>

            <hr />

            <div class="mb-3">
              <label for="new_password" class="form-label"
                >Mật khẩu mới <span class="text-danger">*</span></label
              >
              <div class="input-group">
                <input
                  type="password"
                  class="form-control"
                  id="new_password"
                  name="new_password"
                  required
                />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  onclick="togglePassword('new_password')"
                >
                  <i class="fas fa-eye" id="new_password_icon"></i>
                </button>
              </div>
              <div class="password-strength" id="passwordStrength"></div>
              <div class="password-requirements mt-2">
                <small class="text-muted">Mật khẩu phải có:</small>
                <ul class="mb-0">
                  <li class="requirement" id="req-length">
                    <i class="fas fa-circle"></i> Ít nhất 8 ký tự
                  </li>
                  <li class="requirement" id="req-uppercase">
                    <i class="fas fa-circle"></i> Ít nhất 1 chữ hoa
                  </li>
                  <li class="requirement" id="req-lowercase">
                    <i class="fas fa-circle"></i> Ít nhất 1 chữ thường
                  </li>
                  <li class="requirement" id="req-number">
                    <i class="fas fa-circle"></i> Ít nhất 1 chữ số
                  </li>
                </ul>
              </div>
            </div>

            <div class="mb-3">
              <label for="confirm_password" class="form-label"
                >Xác nhận mật khẩu mới <span class="text-danger">*</span></label
              >
              <div class="input-group">
                <input
                  type="password"
                  class="form-control"
                  id="confirm_password"
                  name="confirm_password"
                  required
                />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  onclick="togglePassword('confirm_password')"
                >
                  <i class="fas fa-eye" id="confirm_password_icon"></i>
                </button>
              </div>
              <small class="text-muted" id="passwordMatch"></small>
            </div>

            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> Sau khi đổi mật khẩu, bạn sẽ
              cần đăng nhập lại.
            </div>

            <div class="d-flex justify-content-between">
              <a href="{{ url_for('auth.profile') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại
              </a>
              <button
                type="submit"
                class="btn btn-warning"
                id="submitBtn"
                disabled
              >
                <i class="fas fa-save"></i> Đổi mật khẩu
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Security Tips -->
      <div class="card mt-4">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0"><i class="fas fa-shield-alt"></i> Mẹo bảo mật</h6>
        </div>
        <div class="card-body">
          <ul class="mb-0">
            <li>Không sử dụng mật khẩu giống với các tài khoản khác</li>
            <li>Không chia sẻ mật khẩu với bất kỳ ai</li>
            <li>Đổi mật khẩu định kỳ (3-6 tháng)</li>
            <li>Sử dụng mật khẩu mạnh với nhiều loại ký tự</li>
            <li>Đăng xuất khỏi thiết bị công cộng sau khi sử dụng</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Toggle password visibility
  function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + "_icon");

    if (field.type === "password") {
      field.type = "text";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    } else {
      field.type = "password";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    }
  }

  // Check password strength
  function checkPasswordStrength(password) {
    let strength = 0;
    const requirements = {
      length: password.length >= 8,
      uppercase: /[A-Z]/.test(password),
      lowercase: /[a-z]/.test(password),
      number: /[0-9]/.test(password),
      special: /[^A-Za-z0-9]/.test(password),
    };

    // Update requirements display
    document
      .getElementById("req-length")
      .classList.toggle("met", requirements.length);
    document
      .getElementById("req-uppercase")
      .classList.toggle("met", requirements.uppercase);
    document
      .getElementById("req-lowercase")
      .classList.toggle("met", requirements.lowercase);
    document
      .getElementById("req-number")
      .classList.toggle("met", requirements.number);

    // Calculate strength
    if (requirements.length) strength++;
    if (requirements.uppercase) strength++;
    if (requirements.lowercase) strength++;
    if (requirements.number) strength++;
    if (requirements.special) strength++;

    const strengthBar = document.getElementById("passwordStrength");
    strengthBar.className = "password-strength";

    if (strength <= 2) {
      strengthBar.classList.add("strength-weak");
    } else if (strength <= 4) {
      strengthBar.classList.add("strength-medium");
    } else {
      strengthBar.classList.add("strength-strong");
    }

    return (
      requirements.length &&
      requirements.uppercase &&
      requirements.lowercase &&
      requirements.number
    );
  }

  // Real-time password validation
  const newPassword = document.getElementById("new_password");
  const confirmPassword = document.getElementById("confirm_password");
  const oldPassword = document.getElementById("old_password");
  const submitBtn = document.getElementById("submitBtn");
  const passwordMatch = document.getElementById("passwordMatch");

  newPassword.addEventListener("input", function () {
    checkPasswordStrength(this.value);
    validateForm();
  });

  confirmPassword.addEventListener("input", validateForm);
  oldPassword.addEventListener("input", validateForm);

  function validateForm() {
    const newPwd = newPassword.value;
    const confirmPwd = confirmPassword.value;
    const oldPwd = oldPassword.value;

    // Check if passwords match
    if (confirmPwd) {
      if (newPwd === confirmPwd) {
        passwordMatch.textContent = "✓ Mật khẩu khớp";
        passwordMatch.className = "text-success";
      } else {
        passwordMatch.textContent = "✗ Mật khẩu không khớp";
        passwordMatch.className = "text-danger";
      }
    } else {
      passwordMatch.textContent = "";
    }

    // Enable submit button if all conditions are met
    const isValid =
      oldPwd.length > 0 &&
      checkPasswordStrength(newPwd) &&
      newPwd === confirmPwd &&
      newPwd !== oldPwd;

    submitBtn.disabled = !isValid;
  }

  // Form submission
  document
    .getElementById("changePasswordForm")
    .addEventListener("submit", function (e) {
      const newPwd = newPassword.value;
      const oldPwd = oldPassword.value;

      if (newPwd === oldPwd) {
        e.preventDefault();
        alert("Mật khẩu mới phải khác mật khẩu cũ");
        return false;
      }

      if (!checkPasswordStrength(newPwd)) {
        e.preventDefault();
        alert("Mật khẩu không đủ mạnh. Vui lòng kiểm tra các yêu cầu.");
        return false;
      }

      if (newPwd !== confirmPassword.value) {
        e.preventDefault();
        alert("Mật khẩu xác nhận không khớp");
        return false;
      }
    });
</script>
{% endblock %}
