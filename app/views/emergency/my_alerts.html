{% extends "base.html" %} {% block title %} {% if is_admin %}Quản lý cảnh báo
khẩn cấp{% else %}Cảnh báo khẩn cấp của tôi{% endif %} - SmartRent {% endblock
%} {% block content %}

<!-- Notification Container (Admin only) -->
{% if is_admin %}
<div id="notificationContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050; max-width: 400px;">
</div>
{% endif %}

<div class="container mt-4">
  <h2>
    <i class="fas fa-exclamation-triangle"></i>
    {% if is_admin %} Quản lý cảnh báo khẩn cấp
    <span class="badge bg-danger">ADMIN</span>
    {% else %} Cảnh báo khẩn cấp của tôi {% endif %}
  </h2>
  <hr />

  <!-- Statistics Cards (Filterable) -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center alert-filter-card" onclick="filterAlerts('all')" style="cursor: pointer;">
        <div class="card-body">
          <i class="fas fa-bell fa-2x text-warning mb-2"></i>
          <h5 class="card-title">Tổng cảnh báo</h5>
          <h3 class="text-warning">{{ alerts|length }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center alert-filter-card" onclick="filterAlerts('open')" style="cursor: pointer;">
        <div class="card-body">
          <i class="fas fa-exclamation-circle fa-2x text-danger mb-2"></i>
          <h5 class="card-title">Đang mở</h5>
          <h3 class="text-danger">
            {{ alerts|selectattr('status', 'equalto', 'open')|list|length }}
          </h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center alert-filter-card" onclick="filterAlerts('resolved')" style="cursor: pointer;">
        <div class="card-body">
          <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
          <h5 class="card-title">Đã giải quyết</h5>
          <h3 class="text-success">
            {{ alerts|selectattr('status', 'equalto', 'resolved')|list|length }}
          </h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center alert-filter-card" onclick="filterAlerts('closed')" style="cursor: pointer;">
        <div class="card-body">
          <i class="fas fa-lock fa-2x text-secondary mb-2"></i>
          <h5 class="card-title">Đã đóng</h5>
          <h3 class="text-secondary">
            {{ alerts|selectattr('status', 'equalto', 'closed')|list|length }}
          </h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Emergency Report Button -->
  <div class="mb-4">
    <button
      class="btn btn-danger btn-lg"
      data-bs-toggle="modal"
      data-bs-target="#reportModal"
    >
      <i class="fas fa-exclamation-triangle"></i> Báo cáo khẩn cấp mới
    </button>
  </div>

  <!-- Alerts List -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-list"></i> Danh sách cảnh báo</h5>
    </div>
    <div class="card-body">
      {% if alerts %}
      <div class="list-group" id="alertsList">
        {% for alert in alerts %}
        <div class="list-group-item alert-item" data-status="{{ alert.status }}" data-alert-id="{{ alert.id }}">
          <div class="row align-items-center">
            <div class="col-md-1 text-center">
              {% if alert.severity == 'critical' %}
              <i class="fas fa-exclamation-circle fa-3x text-danger"></i>
              {% elif alert.severity == 'high' %}
              <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
              {% elif alert.severity == 'medium' %}
              <i class="fas fa-info-circle fa-3x text-info"></i>
              {% else %}
              <i class="fas fa-check-circle fa-3x text-success"></i>
              {% endif %}
            </div>
            <div class="col-md-2">
              <h6 class="mb-1">
                <strong>{{ alert.alert_code }}</strong>
              </h6>
              <p class="mb-0">
                <span
                  class="badge {% if alert.severity == 'critical' %}bg-danger {% elif alert.severity == 'high' %}bg-warning {% elif alert.severity == 'medium' %}bg-info {% else %}bg-secondary{% endif %}"
                >
                  {{ alert.severity|upper }}
                </span>
              </p>
            </div>
            <div class="col-md-2">
              <h6 class="mb-1"><i class="fas fa-tag"></i> Loại</h6>
              <p class="mb-0">
                {% if alert.alert_type == 'accident' %}
                <span class="badge bg-danger"
                  ><i class="fas fa-car-crash"></i> Tai nạn</span
                >
                {% elif alert.alert_type == 'breakdown' %}
                <span class="badge bg-warning"
                  ><i class="fas fa-wrench"></i> Hỏng hóc</span
                >
                {% elif alert.alert_type == 'theft' %}
                <span class="badge bg-dark"
                  ><i class="fas fa-user-secret"></i> Mất cắp</span
                >
                {% elif alert.alert_type == 'medical' %}
                <span class="badge bg-danger"
                  ><i class="fas fa-ambulance"></i> Y tế</span
                >
                {% elif alert.alert_type == 'emergency' %}
                <span class="badge bg-danger"
                  ><i class="fas fa-exclamation"></i> SOS</span
                >
                {% else %}
                <span class="badge bg-secondary">{{ alert.alert_type }}</span>
                {% endif %}
              </p>
            </div>
            <div class="col-md-3">
              <h6 class="mb-1"><i class="fas fa-info-circle"></i> Mô tả</h6>
              <p class="mb-0 text-muted">
                <small>{{ alert.description or 'Không có mô tả' }}</small>
              </p>
            </div>
            <div class="col-md-2">
              <h6 class="mb-1"><i class="fas fa-calendar"></i> Thời gian</h6>
              <p class="mb-0">
                <small>{{ alert.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
              </p>
            </div>
            <div class="col-md-2">
              <h6 class="mb-1"><i class="fas fa-flag"></i> Trạng thái</h6>
              <p class="mb-0">
                {% if alert.status == 'open' %}
                <span class="badge bg-danger">Đang mở</span>
                {% elif alert.status == 'acknowledged' %}
                <span class="badge bg-warning">Đã tiếp nhận</span>
                {% elif alert.status == 'resolved' %}
                <span class="badge bg-success">Đã giải quyết</span>
                {% elif alert.status == 'closed' %}
                <span class="badge bg-secondary">Đã đóng</span>
                {% else %}
                <span class="badge bg-secondary">{{ alert.status }}</span>
                {% endif %}
              </p>
              {% if is_admin %}
              <button
                class="btn btn-sm btn-primary mt-2"
                onclick="updateAlertStatus({{ alert.id }}, '{{ alert.alert_code }}', '{{ alert.status }}')"
              >
                <i class="fas fa-edit"></i> Cập nhật
              </button>
              {% else %}
              <!-- User actions -->
              {% if alert.status == 'open' %}
              <div class="mt-2">
                <button
                  class="btn btn-sm btn-warning w-100 mb-1"
                  data-bs-toggle="modal"
                  data-bs-target="#editAlertModal"
                  onclick="loadEditAlert({{ alert.id }}, '{{ alert.alert_type }}', '{{ alert.severity }}', '{{ alert.description|replace('"', '&quot;') }}')"
                >
                  <i class="fas fa-edit"></i> Chỉnh sửa
                </button>
                <button
                  class="btn btn-sm btn-danger w-100"
                  onclick="deleteAlert({{ alert.id }}, '{{ alert.alert_code }}')"
                >
                  <i class="fas fa-trash"></i> Xóa
                </button>
              </div>
              {% endif %}
              {% endif %}
            </div>
          </div>

          <!-- Show user info for admin -->
          {% if is_admin and alert.user %}
          <div class="mt-2">
            <small class="text-muted">
              <i class="fas fa-user"></i> Người báo cáo:
              <strong>{{ alert.user.full_name or alert.user.username }}</strong>
              ({{ alert.user.email }}) {% if alert.user.phone %} - {{
              alert.user.phone }}{% endif %}
            </small>
          </div>
          {% endif %}

          <!-- Additional Info (Collapsible) -->
          {% if alert.vehicle or alert.latitude or alert.response_team %}
          <div class="mt-3 pt-3 border-top">
            <div class="row">
              {% if alert.vehicle %}
              <div class="col-md-3">
                <small class="text-muted">
                  <i class="fas fa-car"></i> Phương tiện:
                  <strong>{{ alert.vehicle.vehicle_code }}</strong>
                  ({{ alert.vehicle.brand }} {{ alert.vehicle.model }})
                </small>
              </div>
              {% endif %} {% if alert.latitude and alert.longitude %}
              <div class="col-md-4">
                <small class="text-muted">
                  <i class="fas fa-map-marker-alt"></i> Vị trí:
                  <a
                    href="https://www.google.com/maps?q={{ alert.latitude }},{{ alert.longitude }}"
                    target="_blank"
                  >
                    {{ alert.latitude|round(5) }}, {{ alert.longitude|round(5)
                    }}
                  </a>
                </small>
              </div>
              {% endif %} {% if alert.response_team %}
              <div class="col-md-3">
                <small class="text-muted">
                  <i class="fas fa-users"></i> Đội ứng cứu:
                  <strong>{{ alert.response_team }}</strong>
                </small>
              </div>
              {% endif %} {% if alert.response_time %}
              <div class="col-md-2">
                <small class="text-muted">
                  <i class="fas fa-clock"></i> Phản hồi: {{
                  alert.response_time.strftime('%H:%M %d/%m') }}
                </small>
              </div>
              {% endif %}
            </div>
            {% if alert.resolution_notes %}
            <div class="row mt-2">
              <div class="col-md-12">
                <small class="text-muted">
                  <i class="fas fa-file-alt"></i> Ghi chú giải quyết:
                  <em>{{ alert.resolution_notes }}</em>
                </small>
              </div>
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center text-muted py-5">
        <i class="fas fa-check-circle fa-3x mb-3"></i>
        <p>Chưa có cảnh báo khẩn cấp nào</p>
        <p class="text-success">
          Điều này là tốt! Hãy giữ an toàn khi di chuyển.
        </p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Report Emergency Modal -->
<div
  class="modal fade"
  id="reportModal"
  tabindex="-1"
  aria-labelledby="reportModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="reportModalLabel">
          <i class="fas fa-exclamation-triangle"></i> Báo cáo khẩn cấp
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-info-circle"></i>
          <strong>Chỉ sử dụng trong trường hợp khẩn cấp thực sự!</strong>
          Đội ứng cứu sẽ được thông báo ngay lập tức.
        </div>

        <form id="emergencyForm">
          <div class="mb-3">
            <label for="alert_type" class="form-label">
              <i class="fas fa-tag"></i> Loại khẩn cấp *
            </label>
            <select
              class="form-select"
              id="alert_type"
              name="alert_type"
              required
            >
              <option value="">-- Chọn loại --</option>
              <option value="accident">Tai nạn giao thông</option>
              <option value="breakdown">Hỏng hóc phương tiện</option>
              <option value="theft">Mất cắp / Đe dọa</option>
              <option value="medical">Cấp cứu y tế</option>
              <option value="emergency">Khẩn cấp khác</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="severity" class="form-label">
              <i class="fas fa-exclamation-circle"></i> Mức độ nghiêm trọng *
            </label>
            <select class="form-select" id="severity" name="severity" required>
              <option value="medium">Trung bình</option>
              <option value="high">Cao</option>
              <option value="critical">Cực kỳ nghiêm trọng</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">
              <i class="fas fa-comment"></i> Mô tả tình huống *
            </label>
            <textarea
              class="form-control"
              id="description"
              name="description"
              rows="3"
              placeholder="Mô tả chi tiết tình huống khẩn cấp..."
              required
            ></textarea>
          </div>

          <div class="mb-3">
            <label for="vehicle_id" class="form-label">
              <i class="fas fa-car"></i> Phương tiện (nếu có)
            </label>
            <select class="form-select" id="vehicle_id" name="vehicle_id">
              <option value="">-- Không có --</option>
              {% for vehicle in user_vehicles %}
              <option value="{{ vehicle.id }}">
                {{ vehicle.vehicle_code }} - {{ vehicle.brand }} {{
                vehicle.model }}
              </option>
              {% endfor %}
            </select>
            <div class="form-text">
              Chọn phương tiện nếu sự cố liên quan đến chuyến đi hiện tại
            </div>
          </div>

          <div class="mb-3">
            <button
              type="button"
              class="btn btn-info btn-sm"
              onclick="getCurrentLocation()"
            >
              <i class="fas fa-map-marker-alt"></i> Lấy vị trí hiện tại
            </button>
            <div id="locationInfo" class="mt-2 text-muted"></div>
            <input type="hidden" id="latitude" name="latitude" />
            <input type="hidden" id="longitude" name="longitude" />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Hủy
        </button>
        <button
          type="button"
          class="btn btn-danger"
          onclick="submitEmergency()"
        >
          <i class="fas fa-paper-plane"></i> Gửi cảnh báo khẩn cấp
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Alert Modal -->
<div
  class="modal fade"
  id="editAlertModal"
  tabindex="-1"
  aria-labelledby="editAlertModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="editAlertModalLabel">
          <i class="fas fa-edit"></i> Chỉnh sửa cảnh báo
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <strong>Lưu ý:</strong> Bạn chỉ có thể chỉnh sửa cảnh báo khi nó vẫn ở trạng thái "Đang mở".
        </div>

        <form>
          <input type="hidden" id="editAlertId" />

          <div class="mb-3">
            <label for="editAlertType" class="form-label">
              <i class="fas fa-tag"></i> Loại khẩn cấp *
            </label>
            <select
              class="form-select"
              id="editAlertType"
              name="alert_type"
              required
            >
              <option value="">-- Chọn loại --</option>
              <option value="accident">Tai nạn giao thông</option>
              <option value="breakdown">Hỏng hóc phương tiện</option>
              <option value="theft">Mất cắp / Đe dọa</option>
              <option value="medical">Cấp cứu y tế</option>
              <option value="emergency">Khẩn cấp khác</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="editSeverity" class="form-label">
              <i class="fas fa-exclamation-circle"></i> Mức độ nghiêm trọng *
            </label>
            <select class="form-select" id="editSeverity" name="severity" required>
              <option value="low">Thấp</option>
              <option value="medium">Trung bình</option>
              <option value="high">Cao</option>
              <option value="critical">Cực kỳ nghiêm trọng</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="editDescription" class="form-label">
              <i class="fas fa-comment"></i> Mô tả tình huống *
            </label>
            <textarea
              class="form-control"
              id="editDescription"
              name="description"
              rows="3"
              placeholder="Mô tả chi tiết tình huống khẩn cấp..."
              required
            ></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Đóng
        </button>
        <button type="button" class="btn btn-warning" onclick="submitEditAlert()">
          <i class="fas fa-check"></i> Cập nhật
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  // Real-time alert notification for Admin
  let lastAlertCheck = new Date();
  let pollingInterval = null;
  const isAdmin = {{ 'true' if is_admin else 'false' }};
  const seenAlerts = new Set();

  function showAlertNotification(alert) {
    const container = document.getElementById('notificationContainer');
    if (!container) return;

    // Skip if already shown
    if (seenAlerts.has(alert.alert_code)) return;
    seenAlerts.add(alert.alert_code);

    // Determine color based on severity
    let severityColor = 'warning';
    let severityIcon = 'fa-exclamation-triangle';
    let severityText = 'TRUNG BÌNH';

    if (alert.severity === 'critical') {
      severityColor = 'danger';
      severityIcon = 'fa-exclamation-circle';
      severityText = 'CỰC KỲ NGHIÊM TRỌNG';
    } else if (alert.severity === 'high') {
      severityColor = 'warning';
      severityIcon = 'fa-exclamation-triangle';
      severityText = 'CAO';
    } else if (alert.severity === 'medium') {
      severityColor = 'info';
      severityIcon = 'fa-info-circle';
      severityText = 'TRUNG BÌNH';
    } else if (alert.severity === 'low') {
      severityColor = 'secondary';
      severityIcon = 'fa-check-circle';
      severityText = 'THẤP';
    }

    // Get alert type label
    let alertTypeLabel = 'SOS';
    if (alert.alert_type === 'accident') alertTypeLabel = 'Tai nạn';
    else if (alert.alert_type === 'breakdown') alertTypeLabel = 'Hỏng hóc';
    else if (alert.alert_type === 'theft') alertTypeLabel = 'Mất cắp';
    else if (alert.alert_type === 'medical') alertTypeLabel = 'Y tế';

    // Create toast notification
    const toastHtml = `
      <div class="toast show mb-2" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-${severityColor} text-white">
          <i class="fas ${severityIcon} me-2"></i>
          <strong class="me-auto">Cảnh báo khẩn cấp mới!</strong>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
          <div class="mb-2">
            <span class="badge bg-${severityColor}">${severityText}</span>
            <span class="badge bg-secondary">${alertTypeLabel}</span>
          </div>
          <p class="mb-2">
            <strong>Mã:</strong> ${alert.alert_code}<br>
            <strong>Người báo cáo:</strong> ${alert.user_name}<br>
            <strong>Phương tiện:</strong> ${alert.vehicle_info}<br>
            <strong>Mô tả:</strong> ${alert.description}
          </p>
          <button class="btn btn-sm btn-${severityColor} w-100" onclick="goToAlert('${alert.alert_code}')">
            <i class="fas fa-eye"></i> Xem chi tiết
          </button>
        </div>
      </div>
    `;

    container.insertAdjacentHTML('beforeend', toastHtml);

    // Auto-hide after 10 seconds
    setTimeout(() => {
      const toasts = container.querySelectorAll('.toast');
      if (toasts.length > 0) {
        toasts[0].remove();
      }
    }, 10000);

    // Play sound notification (if supported)
    try {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj==');
      audio.play().catch(e => console.log('Audio play failed:', e));
    } catch (e) {
      console.log('Audio notification not supported');
    }
  }

  function goToAlert(alertCode) {
    // Scroll to alert in the list
    const alertElement = document.querySelector(`[data-alert-id]`);
    if (alertElement) {
      alertElement.scrollIntoView({ behavior: 'smooth' });
    }
    location.reload();
  }

  function checkNewAlerts() {
    if (!isAdmin) return;

    fetch('/emergency/api/new-alerts')
      .then(response => response.json())
      .then(data => {
        if (data.success && data.alerts && data.alerts.length > 0) {
          data.alerts.forEach(alert => {
            showAlertNotification(alert);
          });
        }
      })
      .catch(error => console.log('Error checking alerts:', error));
  }

  // Start polling for new alerts
  if (isAdmin) {
    // Check immediately
    checkNewAlerts();
    
    // Then check every 5 seconds
    pollingInterval = setInterval(checkNewAlerts, 5000);
  }

  async function getCurrentLocation() {
    if (navigator.geolocation) {
      const locationInfo = document.getElementById("locationInfo");
      locationInfo.innerHTML =
        '<i class="fas fa-spinner fa-spin"></i> Đang lấy vị trí...';

      navigator.geolocation.getCurrentPosition(
        async function (position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          document.getElementById("latitude").value = lat;
          document.getElementById("longitude").value = lng;

          // Show loading while fetching address
          locationInfo.innerHTML = `<i class="fas fa-spinner fa-spin text-info"></i> 
                    Đang chuyển đổi thành địa chỉ...`;

          // Get readable address
          try {
            const address = await getAddressFromCoordinates(lat, lng);
            locationInfo.innerHTML = `<i class="fas fa-check-circle text-success"></i> 
                      <strong>Vị trí:</strong> ${address}<br>
                      <small class="text-muted">(${lat.toFixed(6)}, ${lng.toFixed(6)})</small>`;
          } catch (error) {
            // Fallback to coordinates if address fetch fails
            locationInfo.innerHTML = `<i class="fas fa-check-circle text-success"></i> 
                      Đã lấy vị trí: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          }
        },
        function (error) {
          locationInfo.innerHTML =
            '<i class="fas fa-times-circle text-danger"></i> Không thể lấy vị trí. ' +
            error.message;
        }
      );
    } else {
      alert("Trình duyệt không hỗ trợ định vị.");
    }
  }

  function submitEmergency() {
    const form = document.getElementById("emergencyForm");
    const formData = new FormData(form);

    // Validate required fields
    if (
      !formData.get("alert_type") ||
      !formData.get("severity") ||
      !formData.get("description")
    ) {
      alert("Vui lòng điền đầy đủ thông tin bắt buộc!");
      return;
    }

    const data = {
      alert_type: formData.get("alert_type"),
      severity: formData.get("severity"),
      description: formData.get("description"),
      vehicle_id: formData.get("vehicle_id") || null,
      latitude: formData.get("latitude") || null,
      longitude: formData.get("longitude") || null,
    };

    console.log("Submitting emergency:", data);

    // Disable button
    const submitBtn = event.target;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang gửi...';

    fetch("/emergency/report", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert(
            "Đã gửi cảnh báo khẩn cấp!\nMã cảnh báo: " +
              data.alert_code +
              "\n" +
              data.message
          );
          location.reload();
        } else {
          alert("Lỗi: " + (data.error || "Không thể gửi cảnh báo"));
          submitBtn.disabled = false;
          submitBtn.innerHTML =
            '<i class="fas fa-paper-plane"></i> Gửi cảnh báo khẩn cấp';
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Đã có lỗi xảy ra: " + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML =
          '<i class="fas fa-paper-plane"></i> Gửi cảnh báo khẩn cấp';
      });
  }

  // Update alert status (Admin only)
  function updateAlertStatus(alertId, alertCode, currentStatus) {
    const newStatus = prompt(
      `Cập nhật trạng thái cho cảnh báo ${alertCode}\n\nTrạng thái hiện tại: ${currentStatus}\n\nChọn trạng thái mới:\n- open (Đang mở)\n- acknowledged (Đã tiếp nhận)\n- resolved (Đã giải quyết)\n- closed (Đã đóng)`,
      currentStatus
    );

    if (!newStatus || newStatus === currentStatus) {
      return;
    }

    const validStatuses = ["open", "acknowledged", "resolved", "closed"];
    if (!validStatuses.includes(newStatus)) {
      alert(
        "Trạng thái không hợp lệ! Chọn: open, acknowledged, resolved, closed"
      );
      return;
    }

    const responseTeam = prompt("Đội ứng cứu (tùy chọn):");
    const notes = prompt("Ghi chú giải quyết (tùy chọn):");

    const data = {
      status: newStatus,
    };

    if (responseTeam) data.response_team = responseTeam;
    if (notes) data.resolution_notes = notes;

    fetch(`/emergency/${alertId}/update`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("Đã cập nhật trạng thái cảnh báo!");
          location.reload();
        } else {
          alert("Lỗi: " + (data.error || "Không thể cập nhật"));
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Đã có lỗi xảy ra: " + error.message);
      });
  }

  // Auto-get location when modal opens
  document
    .getElementById("reportModal")
    .addEventListener("shown.bs.modal", function () {
      getCurrentLocation();
    });

  // Load alert data for editing
  function loadEditAlert(alertId, alertType, severity, description) {
    document.getElementById("editAlertId").value = alertId;
    document.getElementById("editAlertType").value = alertType;
    document.getElementById("editSeverity").value = severity;
    document.getElementById("editDescription").value = description;
  }

  // Submit edit alert
  function submitEditAlert() {
    const alertId = document.getElementById("editAlertId").value;
    const alertType = document.getElementById("editAlertType").value;
    const severity = document.getElementById("editSeverity").value;
    const description = document.getElementById("editDescription").value;

    if (!alertType || !severity || !description) {
      alert("Vui lòng điền đầy đủ thông tin!");
      return;
    }

    const data = {
      alert_type: alertType,
      severity: severity,
      description: description,
    };

    const submitBtn = event.target;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang cập nhật...';

    fetch(`/emergency/${alertId}/edit`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("Đã cập nhật cảnh báo!");
          location.reload();
        } else {
          alert("Lỗi: " + (data.error || "Không thể cập nhật"));
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="fas fa-check"></i> Cập nhật';
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Đã có lỗi xảy ra: " + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Cập nhật';
      });
  }

  // Delete alert
  function deleteAlert(alertId, alertCode) {
    if (confirm(`Bạn có chắc chắn muốn xóa cảnh báo ${alertCode}? Hành động này không thể hoàn tác.`)) {
      fetch(`/emergency/${alertId}/delete`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            alert("Đã xóa cảnh báo!");
            location.reload();
          } else {
            alert("Lỗi: " + (data.error || "Không thể xóa"));
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("Đã có lỗi xảy ra: " + error.message);
        });
    }
  }

  // Filter alerts by status
  let currentFilter = 'all';

  function filterAlerts(status) {
    currentFilter = status;
    const alertItems = document.querySelectorAll('.alert-item');
    let visibleCount = 0;

    alertItems.forEach((item) => {
      const itemStatus = item.getAttribute('data-status');
      
      if (status === 'all' || itemStatus === status) {
        item.style.display = '';
        visibleCount++;
      } else {
        item.style.display = 'none';
      }
    });

    // Reset all filter cards first
    const filterCards = document.querySelectorAll('.alert-filter-card');
    filterCards.forEach((card) => {
      card.style.borderWidth = '1px';
      card.style.borderStyle = 'solid';
      card.style.borderColor = '#dee2e6';
      card.style.opacity = '0.7';
    });

    // Highlight selected filter
    const statusIndexMap = {
      'all': 0,
      'open': 1,
      'resolved': 2,
      'closed': 3
    };

    const selectedIndex = statusIndexMap[status];
    if (selectedIndex !== undefined && filterCards[selectedIndex]) {
      const selectedCard = filterCards[selectedIndex];
      selectedCard.style.borderWidth = '3px';
      selectedCard.style.borderStyle = 'solid';
      selectedCard.style.opacity = '1';
      
      // Set appropriate border color based on status
      if (status === 'all') {
        selectedCard.style.borderColor = '#FFC107';
      } else if (status === 'open') {
        selectedCard.style.borderColor = '#DC3545';
      } else if (status === 'resolved') {
        selectedCard.style.borderColor = '#28A745';
      } else if (status === 'closed') {
        selectedCard.style.borderColor = '#6C757D';
      }
    }

    // Show message if no results
    const noResultsMsg = document.getElementById('noFilterResults');
    if (visibleCount === 0) {
      if (!noResultsMsg) {
        const msg = document.createElement('div');
        msg.id = 'noFilterResults';
        msg.className = 'alert alert-info mt-3';
        msg.innerHTML = '<i class="fas fa-info-circle"></i> Không có cảnh báo nào phù hợp với bộ lọc.';
        document.querySelector('#alertsList').after(msg);
      }
    } else if (noResultsMsg) {
      noResultsMsg.remove();
    }
  }

  // Initialize with default filter styling
  document.addEventListener('DOMContentLoaded', function() {
    const firstCard = document.querySelector('.alert-filter-card');
    if (firstCard) {
      firstCard.style.borderWidth = '3px';
      firstCard.style.borderStyle = 'solid';
      firstCard.style.opacity = '1';
      firstCard.style.borderColor = '#FFC107';
    }
    
    // Load addresses for all alerts
    loadAllAddresses();
  });

  // Function to convert coordinates to address using OpenStreetMap Nominatim
  async function getAddressFromCoordinates(lat, lng) {
    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=vi`,
        {
          headers: {
            'User-Agent': 'SmartRent-ITS/1.0'
          }
        }
      );
      
      if (!response.ok) {
        throw new Error('Không thể lấy địa chỉ');
      }
      
      const data = await response.json();
      
      // Format a nice address from the response
      const address = data.address;
      let formattedAddress = '';
      
      if (address.road) formattedAddress += address.road;
      if (address.suburb) formattedAddress += (formattedAddress ? ', ' : '') + address.suburb;
      if (address.city) formattedAddress += (formattedAddress ? ', ' : '') + address.city;
      else if (address.town) formattedAddress += (formattedAddress ? ', ' : '') + address.town;
      else if (address.village) formattedAddress += (formattedAddress ? ', ' : '') + address.village;
      if (address.state) formattedAddress += (formattedAddress ? ', ' : '') + address.state;
      if (address.country) formattedAddress += (formattedAddress ? ', ' : '') + address.country;
      
      // If no detailed address, use display_name
      if (!formattedAddress && data.display_name) {
        formattedAddress = data.display_name;
      }
      
      return formattedAddress || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    } catch (error) {
      console.error('Error fetching address:', error);
      return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }
  }

  // Load addresses for all alert locations on page load
  async function loadAllAddresses() {
    const addressElements = document.querySelectorAll('[id^="address-"]');
    
    for (const element of addressElements) {
      const lat = parseFloat(element.dataset.lat);
      const lng = parseFloat(element.dataset.lng);
      
      if (lat && lng) {
        const address = await getAddressFromCoordinates(lat, lng);
        element.innerHTML = address;
        
        // Add a small delay to avoid rate limiting (max 1 request per second)
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }
  }
</script>
{% endblock %}
