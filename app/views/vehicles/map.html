{% extends "base.html" %}

{% block title %}Bản đồ xe - SmartRent{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-filter"></i> Bộ lọc</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Loại xe</label>
                        <select class="form-select" id="vehicleTypeFilter">
                            <option value="all">Tất cả</option>
                            <option value="bike">Xe đạp điện</option>
                            <option value="motorbike">Xe máy</option>
                            <option value="car">Ô tô</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bán kính tìm kiếm (km)</label>
                        <input type="range" class="form-range" id="radiusFilter" min="1" max="20" value="5">
                        <span id="radiusValue">5 km</span>
                    </div>
                    <button class="btn btn-primary w-100" id="searchBtn">
                        <i class="fas fa-search"></i> Tìm kiếm
                    </button>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h6>Xe gần bạn</h6>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;" id="vehicleList">
                    <p class="text-muted">Đang tải...</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <div class="card">
                <div class="card-body p-0">
                    <div id="map" style="height: 600px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let map;
let userMarker;
let vehicleMarkers = [];
let userLocation = null;

// Initialize map
document.addEventListener('DOMContentLoaded', function() {
    // Default location (Vietnam)
    map = L.map('map').setView([10.8231, 106.6297], 13);
    
    const mapboxToken = {{ mapbox_token|tojson }};
    if (mapboxToken) {
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=' + mapboxToken, {
            attribution: '© <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 20,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1
        }).addTo(map);
    } else {
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
    }
    
    // Get user location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            map.setView([userLocation.lat, userLocation.lng], 15);
            
            // Add user marker
            userMarker = L.marker([userLocation.lat, userLocation.lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                })
            }).addTo(map).bindPopup('Vị trí của bạn');
            
            // Search for nearby vehicles
            searchVehicles();
        });
    }
});

// Search vehicles
function searchVehicles() {
    if (!userLocation) {
        alert('Không thể lấy vị trí của bạn');
        return;
    }
    
    const vehicleType = document.getElementById('vehicleTypeFilter').value;
    const radius = document.getElementById('radiusFilter').value;
    
    fetch(`/vehicles/api/nearby?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=${radius}&type=${vehicleType}`)
        .then(response => response.json())
        .then(data => {
            // Clear existing markers
            vehicleMarkers.forEach(marker => map.removeLayer(marker));
            vehicleMarkers = [];
            
            // Add vehicle markers
            const vehicleList = document.getElementById('vehicleList');
            vehicleList.innerHTML = '';
            
            if (data.vehicles.length === 0) {
                vehicleList.innerHTML = '<p class="text-muted">Không tìm thấy xe nào</p>';
                return;
            }
            
            data.vehicles.forEach(vehicle => {
                // Add marker to map
                const icon = getVehicleIcon(vehicle.type);
                const marker = L.marker([vehicle.latitude, vehicle.longitude], { icon })
                    .addTo(map)
                    .bindPopup(`
                        <strong>${vehicle.brand} ${vehicle.model}</strong><br>
                        Loại: ${vehicle.type}<br>
                        Khoảng cách: ${vehicle.distance} km<br>
                        Pin: ${vehicle.battery}%<br>
                        Giá: ${vehicle.price_per_minute} VND/phút<br>
                        <a href="/vehicles/${vehicle.id}" class="btn btn-sm btn-primary mt-2">Chi tiết</a>
                    `);
                
                vehicleMarkers.push(marker);
                
                // Add to list
                vehicleList.innerHTML += `
                    <div class="card mb-2">
                        <div class="card-body p-2">
                            <h6 class="mb-1">${vehicle.brand} ${vehicle.model}</h6>
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt"></i> ${vehicle.distance} km<br>
                                <i class="fas fa-battery-full"></i> ${vehicle.battery}%
                            </small>
                            <div class="mt-2">
                                <a href="/vehicles/${vehicle.id}" class="btn btn-sm btn-primary">Thuê xe</a>
                            </div>
                        </div>
                    </div>
                `;
            });
        });
}

function getVehicleIcon(type) {
    let color = 'green';
    if (type === 'motorbike') color = 'orange';
    if (type === 'car') color = 'red';
    
    return L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
        iconSize: [25, 41],
        iconAnchor: [12, 41]
    });
}

// Event listeners
document.getElementById('searchBtn').addEventListener('click', searchVehicles);
document.getElementById('radiusFilter').addEventListener('input', function() {
    document.getElementById('radiusValue').textContent = this.value + ' km';
});
</script>
{% endblock %}
