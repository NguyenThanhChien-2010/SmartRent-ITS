{% extends "base.html" %}

{% block title %}B·∫£n ƒë·ªì xe - SmartRent{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-filter"></i> B·ªô l·ªçc</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Lo·∫°i xe</label>
                        <select class="form-select" id="vehicleTypeFilter">
                            <option value="all">T·∫•t c·∫£</option>
                            <option value="bike">Xe ƒë·∫°p</option>
                            <option value="motorbike">Xe m√°y</option>
                            <option value="ebike">Xe ƒë·∫°p ƒëi·ªán</option>
                            <option value="scooter">Scooter</option>
                            <option value="car">√î t√¥</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">B√°n k√≠nh t√¨m ki·∫øm (km)</label>
                        <input type="range" class="form-range" id="radiusFilter" min="1" max="20" value="5">
                        <span id="radiusValue">5 km</span>
                    </div>
                    <button class="btn btn-primary w-100" id="searchBtn">
                        <i class="fas fa-search"></i> T√¨m ki·∫øm
                    </button>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h6>Xe g·∫ßn b·∫°n</h6>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;" id="vehicleList">
                    <p class="text-muted">ƒêang t·∫£i...</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <div class="card">
                <div class="card-body p-0">
                    <div id="map" style="height: 600px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* Remove default Leaflet marker styles */
.custom-div-icon {
    background: transparent !important;
    border: none !important;
}

.vehicle-icon {
    background: #fff;
    border: 3px solid #2196F3;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

/* Status-based colors */
.vehicle-icon.available { border-color: #4CAF50; color: #4CAF50; }
.vehicle-icon.reserved { border-color: #FFC107; color: #FFC107; opacity: 0.8; }
.vehicle-icon.in-use { border-color: #F44336; color: #F44336; opacity: 0.7; }
.vehicle-icon.maintenance { border-color: #9E9E9E; color: #9E9E9E; opacity: 0.6; }

/* Type-based colors (for available vehicles) */
.vehicle-icon.bike.available { border-color: #4CAF50; color: #4CAF50; }
.vehicle-icon.motorbike.available { border-color: #FF9800; color: #FF9800; }
.vehicle-icon.ebike.available { border-color: #9C27B0; color: #9C27B0; }
.vehicle-icon.scooter { border-color: #00BCD4; color: #00BCD4; }
.vehicle-icon.car { border-color: #F44336; color: #F44336; }

.user-icon {
    background: #2196F3;
    border: 3px solid #fff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.vehicle-card:hover {
    background-color: #f8f9fa;
    transform: translateY(-2px);
    transition: all 0.2s ease;
}
</style>

<script>
let map;
let userMarker;
let vehicleMarkers = [];
let userLocation = null;

// Initialize map
document.addEventListener('DOMContentLoaded', function() {
    // Default location (Ho Chi Minh City)
    map = L.map('map').setView([10.8231, 106.6297], 13);
    
    const mapboxToken = {{ mapbox_token|tojson }};
    if (mapboxToken) {
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=' + mapboxToken, {
            attribution: '¬© <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ¬© <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 20,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1
        }).addTo(map);
    } else {
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
    }
    
    // Get user location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            map.setView([userLocation.lat, userLocation.lng], 15);
            
            // Add user marker with custom icon
            const userIcon = L.divIcon({
                html: '<div class="user-icon"><i class="fas fa-user"></i></div>',
                className: 'custom-div-icon',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });
            
            userMarker = L.marker([userLocation.lat, userLocation.lng], {
                icon: userIcon
            }).addTo(map).bindPopup('<strong>V·ªã tr√≠ c·ªßa b·∫°n</strong>');
            
            // Search for nearby vehicles
            searchVehicles();
        });
    }
});

// Search vehicles
function searchVehicles() {
    if (!userLocation) {
        alert('Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ c·ªßa b·∫°n');
        return;
    }
    
    const vehicleType = document.getElementById('vehicleTypeFilter').value;
    const radius = document.getElementById('radiusFilter').value;
    
    // Add show_all=true to see all vehicles (including non-available)
    fetch(`/vehicles/api/nearby?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=${radius}&type=${vehicleType}&show_all=true`)
        .then(response => response.json())
        .then(data => {
            // Clear existing markers
            vehicleMarkers.forEach(marker => map.removeLayer(marker));
            vehicleMarkers = [];
            
            // Add vehicle markers
            const vehicleList = document.getElementById('vehicleList');
            vehicleList.innerHTML = '';
            
            // Show debug info
            console.log('Vehicle counts by status:', data.status_counts);
            console.log('Total vehicles found:', data.count);
            console.log('Available vehicles:', data.available_count);
            
            if (data.vehicles.length === 0) {
                vehicleList.innerHTML = '<p class="text-muted">Kh√¥ng t√¨m th·∫•y xe n√†o</p>';
                return;
            }
            
            // Add summary at top
            vehicleList.innerHTML = `
                <div class="alert alert-info py-2 px-2 mb-2">
                    <small>
                        <strong>T·ªïng: ${data.count} xe</strong><br>
                        ‚úÖ Kh·∫£ d·ª•ng: ${data.status_counts.available || 0}<br>
                        üîí ƒê√£ ƒë·∫∑t: ${data.status_counts.reserved || 0}<br>
                        üöó ƒêang d√πng: ${data.status_counts.in_use || 0}<br>
                        üîß B·∫£o tr√¨: ${data.status_counts.maintenance || 0}
                    </small>
                </div>
            `;
            
            data.vehicles.forEach(vehicle => {
                // Get status badge
                let statusBadge = '';
                let statusColor = 'success';
                let canRent = vehicle.status === 'available';
                
                if (vehicle.status === 'available') {
                    statusBadge = '<span class="badge bg-success">Kh·∫£ d·ª•ng</span>';
                } else if (vehicle.status === 'reserved') {
                    statusBadge = '<span class="badge bg-warning">ƒê√£ ƒë·∫∑t</span>';
                    statusColor = 'warning';
                } else if (vehicle.status === 'in_use') {
                    statusBadge = '<span class="badge bg-danger">ƒêang d√πng</span>';
                    statusColor = 'danger';
                } else if (vehicle.status === 'maintenance') {
                    statusBadge = '<span class="badge bg-secondary">B·∫£o tr√¨</span>';
                    statusColor = 'secondary';
                }
                
                // Add marker to map with custom icon based on status
                const icon = getVehicleIconByStatus(vehicle.type, vehicle.status);
                const marker = L.marker([vehicle.latitude, vehicle.longitude], { icon })
                    .addTo(map)
                    .bindPopup(`
                        <div style="min-width: 200px;">
                            <strong>${vehicle.brand} ${vehicle.model}</strong><br>
                            <span class="badge bg-primary">${getVehicleTypeName(vehicle.type)}</span>
                            ${statusBadge}<br>
                            <hr style="margin: 8px 0;">
                            <i class="fas fa-map-marker-alt text-danger"></i> ${vehicle.distance} km<br>
                            <i class="fas fa-battery-full text-success"></i> Pin: ${vehicle.battery}%<br>
                            <i class="fas fa-money-bill-wave text-warning"></i> ${vehicle.price_per_minute} VND/ph√∫t<br>
                            ${canRent ? `<a href="/vehicles/${vehicle.id}" class="btn btn-sm btn-primary mt-2 w-100 text-white" style="text-decoration: none;">
                                <i class="fas fa-car"></i> Chi ti·∫øt & Thu√™ xe
                            </a>` : '<button class="btn btn-sm btn-secondary mt-2 w-100" disabled>Kh√¥ng kh·∫£ d·ª•ng</button>'}
                        </div>
                    `);
                
                vehicleMarkers.push(marker);
                
                // Add to list with index for click event
                const markerIndex = vehicleMarkers.length - 1;
                const cardOpacity = canRent ? '1' : '0.6';
                vehicleList.innerHTML += `
                    <div class="card mb-2 vehicle-card" onclick="zoomToVehicle(${markerIndex})" style="cursor: pointer; opacity: ${cardOpacity};">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="mb-1">${vehicle.brand} ${vehicle.model}</h6>
                                ${statusBadge}
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt"></i> ${vehicle.distance} km<br>
                                <i class="fas fa-battery-full"></i> ${vehicle.battery}%
                            </small>
                            <div class="mt-2">
                                ${canRent ? `<a href="/vehicles/${vehicle.id}" class="btn btn-sm btn-primary text-white" onclick="event.stopPropagation();">Thu√™ xe</a>` : '<button class="btn btn-sm btn-secondary" disabled>Kh√¥ng kh·∫£ d·ª•ng</button>'}
                            </div>
                        </div>
                    </div>
                `;
            });
        })
        .catch(error => {
            console.error('Error fetching vehicles:', error);
            document.getElementById('vehicleList').innerHTML = '<p class="text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu xe</p>';
        });
}

function getVehicleIcon(type) {
    const iconMap = {
        'bike': 'fa-bicycle',
        'motorbike': 'fa-motorcycle',
        'ebike': 'fa-bicycle',
        'scooter': 'fa-motorcycle',
        'car': 'fa-car'
    };
    
    const icon = iconMap[type] || 'fa-car';
    
    return L.divIcon({
        html: `<div class="vehicle-icon ${type}"><i class="fas ${icon}"></i></div>`,
        className: 'custom-div-icon',
        iconSize: [45, 45],
        iconAnchor: [22, 22],
        popupAnchor: [0, -22]
    });
}

function getVehicleIconByStatus(type, status) {
    const iconMap = {
        'bike': 'fa-bicycle',
        'motorbike': 'fa-motorcycle',
        'ebike': 'fa-bicycle',
        'scooter': 'fa-motorcycle',
        'car': 'fa-car'
    };
    
    const icon = iconMap[type] || 'fa-car';
    
    // Change icon color based on status
    let statusClass = 'available';
    if (status === 'reserved') statusClass = 'reserved';
    else if (status === 'in_use') statusClass = 'in-use';
    else if (status === 'maintenance') statusClass = 'maintenance';
    
    return L.divIcon({
        html: `<div class="vehicle-icon ${type} ${statusClass}"><i class="fas ${icon}"></i></div>`,
        className: 'custom-div-icon',
        iconSize: [45, 45],
        iconAnchor: [22, 22],
        popupAnchor: [0, -22]
    });
}

function getVehicleTypeName(type) {
    const names = {
        'bike': 'Xe ƒë·∫°p',
        'motorbike': 'Xe m√°y',
        'ebike': 'Xe ƒë·∫°p ƒëi·ªán',
        'scooter': 'Scooter ƒëi·ªán',
        'car': '√î t√¥'
    };
    return names[type] || type;
}

// Zoom to specific vehicle marker
function zoomToVehicle(index) {
    if (index >= 0 && index < vehicleMarkers.length) {
        const marker = vehicleMarkers[index];
        map.setView(marker.getLatLng(), 17);
        marker.openPopup();
    }
}

// Event listeners
document.getElementById('searchBtn').addEventListener('click', searchVehicles);
document.getElementById('radiusFilter').addEventListener('input', function() {
    document.getElementById('radiusValue').textContent = this.value + ' km';
});
</script>
{% endblock %}
