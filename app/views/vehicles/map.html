{% extends "base.html" %} {% block title %}B·∫£n ƒë·ªì xe - SmartRent{% endblock %}
{% block content %}
<div class="container-fluid mt-3">
  <div class="row">
    <div class="col-md-3">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5><i class="fas fa-filter"></i> B·ªô l·ªçc</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Lo·∫°i xe</label>
            <select class="form-select" id="vehicleTypeFilter">
              <option value="all">T·∫•t c·∫£</option>
              <option value="motorbike">Xe m√°y</option>
              <option value="car">√î t√¥</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">B√°n k√≠nh t√¨m ki·∫øm (km)</label>
            <input
              type="range"
              class="form-range"
              id="radiusFilter"
              min="1"
              max="20"
              value="5"
            />
            <span id="radiusValue">5 km</span>
          </div>
          <button class="btn btn-primary w-100" id="searchBtn">
            <i class="fas fa-search"></i> T√¨m ki·∫øm
          </button>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header">
          <h6>Xe g·∫ßn b·∫°n</h6>
        </div>
        <div
          class="card-body"
          style="max-height: 400px; overflow-y: auto"
          id="vehicleList"
        >
          <p class="text-muted">ƒêang t·∫£i...</p>
        </div>
      </div>
    </div>

    <div class="col-md-9">
      <div class="card">
        <div class="card-body p-0">
          <div id="map" style="height: 600px"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<!-- Leaflet Routing Machine CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
/>

<style>
  /* Vehicle marker styles */
  .custom-div-icon {
    background: transparent !important;
    border: none !important;
  }

  .vehicle-icon {
    background: #fff;
    border: 3px solid #2196f3;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  /* Status-based colors */
  .vehicle-icon.available {
    border-color: #4caf50;
    color: #4caf50;
  }
  .vehicle-icon.reserved {
    border-color: #ffc107;
    color: #ffc107;
    opacity: 0.8;
  }
  .vehicle-icon.in-use {
    border-color: #f44336;
    color: #f44336;
    opacity: 0.7;
  }
  .vehicle-icon.maintenance {
    border-color: #9e9e9e;
    color: #9e9e9e;
    opacity: 0.6;
  }

  .user-icon {
    background: #2196f3;
    border: 3px solid #fff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  .vehicle-card:hover {
    background-color: #f8f9fa;
    transform: translateY(-2px);
    transition: all 0.2s ease;
  }

  /* Hide default routing control */
  .leaflet-routing-container {
    display: none;
  }
</style>

<!-- Leaflet Routing Machine JS -->
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
  let map;
  let userMarker;
  let vehicleMarkers = [];
  let userLocation = null;
  let routingControl = null;

  // Initialize map
  document.addEventListener("DOMContentLoaded", function () {
    // Default location (Ho Chi Minh City)
    map = L.map("map").setView([10.8231, 106.6297], 13);

    // Add OpenStreetMap tiles (FREE!)
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution:
        '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19,
    }).addTo(map);

    // Get user location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
        };

        map.setView([userLocation.lat, userLocation.lng], 15);

        // Add user marker
        const userIcon = L.divIcon({
          html: '<div class="user-icon"><i class="fas fa-user"></i></div>',
          className: "custom-div-icon",
          iconSize: [40, 40],
          iconAnchor: [20, 20],
        });

        userMarker = L.marker([userLocation.lat, userLocation.lng], {
          icon: userIcon,
        })
          .addTo(map)
          .bindPopup("<strong>V·ªã tr√≠ c·ªßa b·∫°n</strong>");

        // Search for nearby vehicles
        searchVehicles();
      });
    }
  });

  // Search vehicles
  function searchVehicles() {
    if (!userLocation) {
      alert("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ c·ªßa b·∫°n");
      return;
    }

    const vehicleType = document.getElementById("vehicleTypeFilter").value;
    const radius = document.getElementById("radiusFilter").value;

    fetch(
      `/vehicles/api/nearby?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=${radius}&type=${vehicleType}&show_all=true`,
    )
      .then((response) => response.json())
      .then((data) => {
        // Clear existing markers
        vehicleMarkers.forEach((marker) => map.removeLayer(marker));
        vehicleMarkers = [];

        // Add vehicle markers
        const vehicleList = document.getElementById("vehicleList");
        vehicleList.innerHTML = "";

        console.log("Vehicle counts by status:", data.status_counts);
        console.log("Total vehicles found:", data.count);

        if (data.vehicles.length === 0) {
          vehicleList.innerHTML =
            '<p class="text-muted">Kh√¥ng t√¨m th·∫•y xe n√†o</p>';
          return;
        }

        // Clear vehicle list
        vehicleList.innerHTML = "";

        data.vehicles.forEach((vehicle, index) => {
          // Get status badge
          let statusBadge = "";
          let canRent = vehicle.status === "available";

          if (vehicle.status === "available") {
            statusBadge = '<span class="badge bg-success">Kh·∫£ d·ª•ng</span>';
          } else if (vehicle.status === "reserved") {
            statusBadge = '<span class="badge bg-warning">ƒê√£ ƒë·∫∑t</span>';
          } else if (vehicle.status === "in_use") {
            statusBadge = '<span class="badge bg-danger">ƒêang d√πng</span>';
          } else if (vehicle.status === "maintenance") {
            statusBadge = '<span class="badge bg-secondary">B·∫£o tr√¨</span>';
          }

          // Add marker to map
          const icon = getVehicleIconByStatus(vehicle.type, vehicle.status);
          const marker = L.marker([vehicle.latitude, vehicle.longitude], {
            icon,
          }).addTo(map).bindPopup(`
                        <div style="min-width: 200px;">
                            <strong>${vehicle.brand} ${
                              vehicle.model
                            }</strong><br>
                            <span class="badge bg-primary">${getVehicleTypeName(
                              vehicle.type,
                            )}</span>
                            ${statusBadge}<br>
                            <hr style="margin: 8px 0;">
                            ${vehicle.license_plate ? `<i class="fas fa-id-card text-info"></i> Bi·ªÉn s·ªë: <strong>${vehicle.license_plate}</strong><br>` : ""}
                            <i class="fas fa-map-marker-alt text-danger"></i> ${
                              vehicle.distance
                            } km<br>
                            <i class="fas fa-money-bill-wave text-warning"></i> ${
                              vehicle.price_per_minute
                            } VND/ph√∫t<br>
                            ${
                              canRent
                                ? `
                                <a href="/vehicles/${vehicle.id}" class="btn btn-sm btn-primary mt-2 w-100 text-white" style="text-decoration: none;">
                                    <i class="fas fa-car"></i> Chi ti·∫øt & Thu√™ xe
                                </a>
                                <button class="btn btn-sm btn-info mt-1 w-100" onclick="showDirections(${vehicle.latitude}, ${vehicle.longitude}, '${vehicle.brand} ${vehicle.model}')">
                                    <i class="fas fa-route"></i> Ch·ªâ ƒë∆∞·ªùng
                                </button>
                            `
                                : '<button class="btn btn-sm btn-secondary mt-2 w-100" disabled>Kh√¥ng kh·∫£ d·ª•ng</button>'
                            }
                        </div>
                    `);

          vehicleMarkers.push(marker);

          // Add to list
          const cardOpacity = canRent ? "1" : "0.6";
          vehicleList.innerHTML += `
                    <div class="card mb-2 vehicle-card" onclick="zoomToVehicle(${index})" style="cursor: pointer; opacity: ${cardOpacity};">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="mb-1">${vehicle.brand} ${
                                  vehicle.model
                                }</h6>
                                ${statusBadge}
                            </div>
                            ${vehicle.license_plate ? `<small class="text-info"><i class="fas fa-id-card"></i> ${vehicle.license_plate}</small><br>` : ""}
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt"></i> ${
                                  vehicle.distance
                                } km
                            </small>
                            <div class="mt-2">
                                ${
                                  canRent
                                    ? `
                                    <a href="/vehicles/${vehicle.id}" class="btn btn-sm btn-primary text-white" onclick="event.stopPropagation();">Thu√™ xe</a>
                                    <button class="btn btn-sm btn-info text-white btn-sm" onclick="event.stopPropagation(); showDirections(${vehicle.latitude}, ${vehicle.longitude}, '${vehicle.brand} ${vehicle.model}');">
                                        <i class="fas fa-route"></i>
                                    </button>
                                `
                                    : '<button class="btn btn-sm btn-secondary" disabled>Kh√¥ng kh·∫£ d·ª•ng</button>'
                                }
                            </div>
                        </div>
                    </div>
                `;
        });
      })
      .catch((error) => {
        console.error("Error fetching vehicles:", error);
        document.getElementById("vehicleList").innerHTML =
          '<p class="text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu xe</p>';
      });
  }

  function getVehicleIcon(type) {
    const iconMap = {
      motorbike: "fa-motorcycle",
      car: "fa-car",
    };

    const icon = iconMap[type] || "fa-car";

    return L.divIcon({
      html: `<div class="vehicle-icon ${type}"><i class="fas ${icon}"></i></div>`,
      className: "custom-div-icon",
      iconSize: [45, 45],
      iconAnchor: [22, 22],
      popupAnchor: [0, -22],
    });
  }

  function getVehicleIconByStatus(type, status) {
    const iconMap = {
      motorbike: "fa-motorcycle",
      car: "fa-car",
    };

    const icon = iconMap[type] || "fa-car";

    // Change icon color based on status
    let statusClass = "available";
    if (status === "reserved") statusClass = "reserved";
    else if (status === "in_use") statusClass = "in-use";
    else if (status === "maintenance") statusClass = "maintenance";

    return L.divIcon({
      html: `<div class="vehicle-icon ${type} ${statusClass}"><i class="fas ${icon}"></i></div>`,
      className: "custom-div-icon",
      iconSize: [45, 45],
      iconAnchor: [22, 22],
      popupAnchor: [0, -22],
    });
  }

  function getVehicleTypeName(type) {
    const names = {
      motorbike: "Xe m√°y",
      car: "√î t√¥",
    };
    return names[type] || type;
  }

  // Show directions from user to vehicle using OSRM (FREE!)
  function showDirections(vehicleLat, vehicleLng, vehicleName) {
    if (!userLocation) {
      alert("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ c·ªßa b·∫°n");
      return;
    }

    // Remove existing route
    if (routingControl) {
      map.removeControl(routingControl);
    }

    // Create routing control with OSRM (free routing service)
    routingControl = L.Routing.control({
      waypoints: [
        L.latLng(userLocation.lat, userLocation.lng),
        L.latLng(vehicleLat, vehicleLng),
      ],
      routeWhileDragging: false,
      showAlternatives: false,
      addWaypoints: false,
      router: L.Routing.osrmv1({
        serviceUrl: "https://router.project-osrm.org/route/v1",
      }),
      lineOptions: {
        styles: [
          {
            color: "#2196F3",
            opacity: 0.8,
            weight: 6,
          },
        ],
      },
      createMarker: function () {
        return null;
      }, // Hide default markers
      show: false, // Hide instructions panel
    }).addTo(map);

    // Listen for route found
    routingControl.on("routesfound", function (e) {
      const route = e.routes[0];
      const distance = (route.summary.totalDistance / 1000).toFixed(2);
      const duration = Math.round(route.summary.totalTime / 60);

      alert(
        `üöó Ch·ªâ ƒë∆∞·ªùng ƒë·∫øn ${vehicleName}\n\nüìç Kho·∫£ng c√°ch: ${distance} km\n‚è±Ô∏è Th·ªùi gian d·ª± ki·∫øn: ${duration} ph√∫t`,
      );
    });
  }

  // Zoom to specific vehicle marker
  function zoomToVehicle(index) {
    if (index >= 0 && index < vehicleMarkers.length) {
      const marker = vehicleMarkers[index];
      map.setView(marker.getLatLng(), 17);
      marker.openPopup();
    }
  }

  // Event listeners
  document
    .getElementById("searchBtn")
    .addEventListener("click", searchVehicles);
  document
    .getElementById("radiusFilter")
    .addEventListener("input", function () {
      document.getElementById("radiusValue").textContent = this.value + " km";
    });
</script>
{% endblock %}
