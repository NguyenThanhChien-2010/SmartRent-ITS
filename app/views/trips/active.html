{% extends "base.html" %} {% block title %}Chuy·∫øn ƒëi c·ªßa t√¥i - SmartRent{%
endblock %} {% block extra_css %}
<style>
  /* Force browser to reload this page - version 2.0 */
</style>
{% endblock %} {% block content %}
<div class="container mt-4">
  <h2><i class="fas fa-route"></i> Chuy·∫øn ƒëi c·ªßa t√¥i</h2>
  <hr />

  {% if trip %}
  <!-- Active Trip -->
  <div class="card border-primary">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          {% if trip.status == 'pending' %}
          <i class="fas fa-clock"></i> ƒêang ch·ªù qu√©t QR {% elif trip.status ==
          'in_progress' %} <i class="fas fa-play-circle"></i> ƒêang di chuy·ªÉn {%
          endif %}
        </h5>
        <span class="badge bg-light text-dark">{{ trip.trip_code }}</span>
      </div>
    </div>
    <div class="card-body">
      <!-- Vehicle Info -->
      <div class="row mb-3">
        <div class="col-md-4 text-center">
          <i
            class="fas fa-{{ 'bicycle' if trip.vehicle.vehicle_type == 'bicycle' else ('motorcycle' if trip.vehicle.vehicle_type == 'motorbike' else 'car') }} fa-4x text-primary"
          ></i>
          <h5 class="mt-2">
            {{ trip.vehicle.brand }} {{ trip.vehicle.model }}
          </h5>
          <p class="text-muted">{{ trip.vehicle.vehicle_code }}</p>
        </div>
        <div class="col-md-8">
          <div class="row">
            <div class="col-6 mb-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <i class="fas fa-coins text-warning"></i>
                  <h4>{{ "{:,.0f}".format(trip.vehicle.price_per_minute) }}</h4>
                  <small>VND/ph√∫t</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {% if trip.status == 'pending' %}
      <!-- Email OTP Verification Only -->
      <div class="alert alert-success border-success mb-3">
        <div class="d-flex align-items-center">
          <i class="fas fa-envelope fa-3x text-success me-3"></i>
          <div>
            <strong>üìß Ki·ªÉm tra Email c·ªßa b·∫°n!</strong>
            <p class="mb-0">
              M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn <strong>{{ current_user.email }}</strong>
            </p>
            <p class="mb-0 small text-muted">
              Nh·∫≠p m√£ OTP t·ª´ email ƒë·ªÉ m·ªü kh√≥a xe. M√£ c√≥ hi·ªáu l·ª±c
              <strong>5 ph√∫t</strong>.
            </p>
          </div>
        </div>
      </div>

      <!-- OTP Verification Form -->
      <div class="card border-primary mb-3">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-shield-alt"></i> Nh·∫≠p M√£ OTP</h5>
        </div>
        <div class="card-body">
          <div class="text-center mb-3">
            <i class="fas fa-lock fa-4x text-primary mb-3"></i>
            <h6>Nh·∫≠p m√£ OTP 6 s·ªë t·ª´ email</h6>
          </div>

          <div class="input-group input-group-lg mb-3">
            <span class="input-group-text"><i class="fas fa-key"></i></span>
            <input
              type="text"
              class="form-control text-center fs-3"
              id="otpInput"
              placeholder="000000"
              maxlength="6"
              pattern="[0-9]{6}"
              style="letter-spacing: 10px; font-weight: bold"
            />
            <button
              class="btn btn-success btn-lg"
              type="button"
              onclick="verifyOTP()"
            >
              <i class="fas fa-unlock"></i> M·ªü kh√≥a xe
            </button>
          </div>

          <div class="text-center">
            <p class="text-muted small mb-2">Ch∆∞a nh·∫≠n ƒë∆∞·ª£c email?</p>
            <button class="btn btn-outline-primary" onclick="resendOTP()">
              <i class="fas fa-redo"></i> G·ª≠i l·∫°i m√£ OTP
            </button>
          </div>

          <div id="emailStatus" class="alert mt-3" style="display: none">
            <i class="fas fa-info-circle"></i>
            <span id="emailStatusText"></span>
          </div>
        </div>
      </div>

      {% elif trip.status == 'in_progress' %}
      <!-- Trip In Progress -->
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="card bg-info text-white">
            <div class="card-body">
              <h6><i class="fas fa-clock"></i> Th·ªùi gian ƒë√£ ƒëi</h6>
              <h3 id="tripDuration">ƒêang t√≠nh...</h3>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card bg-success text-white">
            <div class="card-body">
              <h6><i class="fas fa-money-bill-wave"></i> Chi ph√≠ ∆∞·ªõc t√≠nh</h6>
              <h3 id="estimatedCost">0 VND</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Map -->
      <div class="card mb-3">
        <div class="card-body p-0">
          <div id="tripMap" style="height: 400px"></div>
        </div>
      </div>

      <!-- End Trip Button -->
      <button class="btn btn-danger btn-lg w-100" onclick="endTrip()">
        <i class="fas fa-stop-circle"></i> K·∫øt th√∫c chuy·∫øn ƒëi
      </button>
      {% endif %}
    </div>
  </div>

  {% else %}
  <!-- No Active Trip -->
  <div class="alert alert-info">
    <i class="fas fa-info-circle"></i> B·∫°n ch∆∞a c√≥ chuy·∫øn ƒëi n√†o ƒëang di·ªÖn ra.
  </div>
  <a href="/vehicles/map" class="btn btn-primary">
    <i class="fas fa-search"></i> T√¨m xe ƒë·ªÉ thu√™
  </a>
  {% endif %}
</div>
{% endblock %} {% block extra_js %} {% if trip and trip.status == 'in_progress'
%}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
  const startTime = new Date('{{ trip.start_time }}');
  const pricePerMinute = {{ trip.vehicle.price_per_minute }};
  let map, userMarker;

  // Update duration and cost
  setInterval(() => {
      const now = new Date();
      const diff = Math.floor((now - startTime) / 1000);
      const hours = Math.floor(diff / 3600);
      const minutes = Math.floor((diff % 3600) / 60);
      const seconds = diff % 60;

      document.getElementById('tripDuration').textContent =
          `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

      const totalMinutes = diff / 60;
      const cost = Math.ceil(totalMinutes * pricePerMinute);
      document.getElementById('estimatedCost').textContent = cost.toLocaleString('vi-VN') + ' VND';
  }, 1000);

  // Initialize map
  document.addEventListener('DOMContentLoaded', function() {
      map = L.map('tripMap').setView([{{ trip.start_latitude }}, {{ trip.start_longitude }}], 15);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // Track user location (only show current position, don't draw path)
      if (navigator.geolocation) {
          // Get position once on load
          navigator.geolocation.getCurrentPosition(function(position) {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;

              userMarker = L.marker([lat, lng]).addTo(map).bindPopup('V·ªã tr√≠ b·∫Øt ƒë·∫ßu');

              // Add start point marker
              L.marker([{{ trip.start_latitude }}, {{ trip.start_longitude }}], {
                  icon: L.icon({
                      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                      iconSize: [25, 41],
                      iconAnchor: [12, 41],
                      popupAnchor: [1, -34],
                      shadowSize: [41, 41]
                  })
              }).addTo(map).bindPopup('ƒêi·ªÉm xu·∫•t ph√°t');
          });
      }
  });

  function endTrip() {
      if (!confirm('B·∫°n mu·ªën k·∫øt th√∫c chuy·∫øn ƒëi?')) {
          return;
      }

      navigator.geolocation.getCurrentPosition(function(position) {
          fetch('/trips/{{ trip.id }}/end', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                  latitude: position.coords.latitude,
                  longitude: position.coords.longitude
              })
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('Chuy·∫øn ƒëi ƒë√£ k·∫øt th√∫c!\nT·ªïng chi ph√≠: ' + data.total_cost.toLocaleString('vi-VN') + ' VND');
                  window.location.href = '/trips/' + data.trip_id + '/rating';
              } else {
                  alert('L·ªói: ' + data.error);
              }
          });
      });
  }
</script>
{% elif trip and trip.status == 'pending' %}
<script>
  const tripCode = "{{ trip.trip_code }}";

  // Auto-send OTP email on page load
  window.addEventListener("DOMContentLoaded", function () {
    console.log("Auto-sending OTP email...");
    sendOTPEmail();
  });

  function sendOTPEmail() {
    fetch("/trips/{{ trip.id }}/send-otp-email", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        trip_code: tripCode,
        vehicle_code: "{{ trip.vehicle.vehicle_code }}",
        email: "{{ current_user.email }}",
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Email sent:", data);
        if (!data.success) {
          const emailStatusDiv = document.getElementById("emailStatus");
          emailStatusDiv.className = "alert alert-warning";
          emailStatusDiv.style.display = "block";
          document.getElementById("emailStatusText").innerHTML =
            "‚ö†Ô∏è Email ch∆∞a ƒë∆∞·ª£c g·ª≠i: " + (data.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh");
        }
      })
      .catch((error) => {
        console.error("Email error:", error);
      });
  }

  function resendOTP() {
    const btn = event.target;
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML =
      '<span class="spinner-border spinner-border-sm"></span> ƒêang g·ª≠i...';

    const emailStatusDiv = document.getElementById("emailStatus");
    const emailStatusText = document.getElementById("emailStatusText");

    fetch("/trips/{{ trip.id }}/send-otp-email", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        trip_code: tripCode,
        vehicle_code: "{{ trip.vehicle.vehicle_code }}",
        email: "{{ current_user.email }}",
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          emailStatusDiv.className = "alert alert-success";
          emailStatusDiv.style.display = "block";
          emailStatusText.innerHTML =
            "‚úì OTP m·ªõi ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn <strong>" + data.email + "</strong>!";

          btn.innerHTML = '<i class="fas fa-check"></i> ƒê√£ g·ª≠i';
          setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
            emailStatusDiv.style.display = "none";
          }, 3000);
        } else {
          emailStatusDiv.className = "alert alert-danger";
          emailStatusDiv.style.display = "block";
          emailStatusText.textContent =
            "‚úó L·ªói: " + (data.error || "Kh√¥ng th·ªÉ g·ª≠i email");

          btn.innerHTML = originalHTML;
          btn.disabled = false;
        }
      })
      .catch((error) => {
        emailStatusDiv.className = "alert alert-danger";
        emailStatusDiv.style.display = "block";
        emailStatusText.textContent = "‚úó L·ªói m·∫°ng: " + error.message;

        btn.innerHTML = originalHTML;
        btn.disabled = false;
      });
  }

  function verifyOTP() {
    const otpInput = document.getElementById("otpInput");
    const otp = otpInput.value.trim();

    if (otp.length !== 6 || !/^\d{6}$/.test(otp)) {
      alert("Vui l√≤ng nh·∫≠p ƒë√∫ng 6 ch·ªØ s·ªë OTP");
      otpInput.focus();
      return;
    }

    const btn = event.target;
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML =
      '<span class="spinner-border spinner-border-sm"></span> ƒêang m·ªü kh√≥a...';

    // Get or create status elements
    let statusDiv = document.getElementById("emailStatus");
    let statusText = document.getElementById("emailStatusText");

    // If elements don't exist (due to browser cache), create them dynamically
    if (!statusDiv || !statusText) {
      console.warn(
        "‚ö†Ô∏è Status elements not found in DOM, creating dynamically...",
      );

      // Find the OTP input's parent container
      const otpContainer = otpInput.closest(".card-body");

      if (otpContainer) {
        // Create status div if it doesn't exist
        if (!statusDiv) {
          statusDiv = document.createElement("div");
          statusDiv.id = "emailStatus";
          statusDiv.className = "alert mt-3";
          statusDiv.style.display = "none";
          otpContainer.appendChild(statusDiv);
        }

        // Create status text span if it doesn't exist
        if (!statusText) {
          statusText = document.createElement("span");
          statusText.id = "emailStatusText";
          statusDiv.innerHTML = '<i class="fas fa-info-circle"></i> ';
          statusDiv.appendChild(statusText);
        }

        console.log("‚úì Status elements created dynamically");
      } else {
        // Fallback: use alert if can't create elements
        console.error("‚ùå Cannot create status elements, using alert fallback");
      }
    }

    // Show loading status (or fallback to console)
    if (statusDiv && statusText) {
      statusDiv.style.display = "block";
      statusDiv.className = "alert alert-info mt-3";
      statusText.innerHTML =
        '<div class="spinner-border spinner-border-sm me-2"></div>ƒêang x√°c th·ª±c OTP...';
    } else {
      console.log("üîÑ Verifying OTP...");
    }

    fetch("/trips/{{ trip.id }}/verify-otp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        otp: otp,
        vehicle_code: "{{ trip.vehicle.vehicle_code }}",
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Success
          if (statusDiv && statusText) {
            statusDiv.className = "alert alert-success mt-3";
            statusText.innerHTML =
              "‚úì X√°c th·ª±c th√†nh c√¥ng! Xe ƒë√£ m·ªü kh√≥a, chuy·∫øn ƒëi b·∫Øt ƒë·∫ßu...";
          } else {
            alert("‚úì X√°c th·ª±c th√†nh c√¥ng! Xe ƒë√£ m·ªü kh√≥a, chuy·∫øn ƒëi b·∫Øt ƒë·∫ßu...");
          }

          setTimeout(() => {
            location.reload();
          }, 2000);
        } else {
          // Error
          if (statusDiv && statusText) {
            statusDiv.className = "alert alert-danger mt-3";
            statusText.textContent =
              "‚ùå " + (data.error || "OTP kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n");
          } else {
            alert("‚ùå " + (data.error || "OTP kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n"));
          }
          btn.innerHTML = originalHTML;
          btn.disabled = false;
          otpInput.value = "";
          otpInput.focus();
        }
      })
      .catch((error) => {
        // Network error
        if (statusDiv && statusText) {
          statusDiv.className = "alert alert-danger mt-3";
          statusText.textContent = "‚ùå L·ªói k·∫øt n·ªëi: " + error.message;
        } else {
          alert("‚ùå L·ªói k·∫øt n·ªëi: " + error.message);
        }
        btn.innerHTML = originalHTML;
        btn.disabled = false;
      });
  }

  // Auto-focus OTP input and restrict to numbers only
  const otpInputElement = document.getElementById("otpInput");
  if (otpInputElement) {
    otpInputElement.focus();
    otpInputElement.addEventListener("input", function (e) {
      e.target.value = e.target.value.replace(/[^0-9]/g, "");
    });
  }
</script>
{% endif %} {% endblock %}
