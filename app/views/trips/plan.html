{% extends 'base.html' %}

{% block title %}L·∫≠p k·∫ø ho·∫°ch h√†nh tr√¨nh - SmartRent{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    .hazard-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .hazard-modal.show {
        display: flex;
    }
    
    .hazard-modal-content {
        background: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .hazard-item {
        border-left: 4px solid;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
        background: #f8f9fa;
    }
    
    .hazard-critical { border-color: #f44336; background: #ffebee; }
    .hazard-high { border-color: #ff5722; background: #fbe9e7; }
    .hazard-medium { border-color: #ff9800; background: #fff3e0; }
    .hazard-low { border-color: #ffc107; background: #fff8e1; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-route"></i> L·∫≠p k·∫ø ho·∫°ch h√†nh tr√¨nh</h4>
                </div>
                <div class="card-body">
                    <form id="planTripForm">
                        <div class="mb-3">
                            <label for="startLocation" class="form-label">
                                <i class="fas fa-map-marker-alt text-success"></i> ƒêi·ªÉm xu·∫•t ph√°t
                            </label>
                            <input type="text" class="form-control" id="startLocation" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ xu·∫•t ph√°t" required>
                        </div>

                        <div class="mb-3">
                            <label for="endLocation" class="form-label">
                                <i class="fas fa-map-marker-alt text-danger"></i> ƒêi·ªÉm ƒë·∫øn
                            </label>
                            <input type="text" class="form-control" id="endLocation" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒë·∫øn" required>
                        </div>

                        <div class="mb-3">
                            <label for="vehicleType" class="form-label">
                                <i class="fas fa-car"></i> Lo·∫°i ph∆∞∆°ng ti·ªán
                            </label>
                            <select class="form-select" id="vehicleType">
                                <option value="all">T·∫•t c·∫£</option>
                                <option value="bike">Xe ƒë·∫°p</option>
                                <option value="motorbike">Xe m√°y</option>
                                <option value="car">√î t√¥</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search"></i> T√¨m l·ªô tr√¨nh
                        </button>
                    </form>

                    <!-- Results -->
                    <div id="routeResults" class="mt-4 d-none">
                        <hr>
                        <h5><i class="fas fa-info-circle"></i> Th√¥ng tin l·ªô tr√¨nh</h5>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted">Kho·∫£ng c√°ch</h6>
                                        <h4 id="routeDistance">-</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted">Th·ªùi gian</h6>
                                        <h4 id="routeDuration">-</h4>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Warnings -->
                        <div id="routeWarnings" class="d-none">
                            <h6><i class="fas fa-exclamation-triangle text-warning"></i> C·∫£nh b√°o</h6>
                            <div id="warningsList"></div>
                        </div>

                        <!-- Map -->
                        <div id="routeMap" style="height: 400px; border-radius: 8px;" class="mt-3"></div>

                        <!-- Available Vehicles -->
                        <div class="mt-3">
                            <h6><i class="fas fa-car"></i> Xe kh·∫£ d·ª•ng g·∫ßn ƒëi·ªÉm xu·∫•t ph√°t</h6>
                            <div id="nearbyVehicles"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hazard Warning Modal -->
<div id="hazardModal" class="hazard-modal">
    <div class="hazard-modal-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">
                <i class="fas fa-exclamation-triangle text-warning"></i> 
                C·∫£nh b√°o V√πng Nguy hi·ªÉm
            </h4>
            <button class="btn btn-sm btn-outline-secondary" onclick="closeHazardModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="hazardsList"></div>
        
        <div class="mt-3 text-center">
            <button class="btn btn-warning" onclick="closeHazardModal()">
                <i class="fas fa-check"></i> T√¥i ƒë√£ hi·ªÉu
            </button>
            <button class="btn btn-outline-primary" onclick="closeHazardModal()">
                <i class="fas fa-route"></i> T√¨m ƒë∆∞·ªùng kh√°c
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    let map;
    let routeLayer;
    let hazardZones = [];
    let currentRoutePoints = [];

    document.getElementById('planTripForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const startLocation = document.getElementById('startLocation').value;
        const endLocation = document.getElementById('endLocation').value;
        const vehicleType = document.getElementById('vehicleType').value;
        
        // Show loading
        document.getElementById('routeResults').classList.remove('d-none');
        document.getElementById('routeDistance').innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        document.getElementById('routeDuration').innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        // For demo: use mock data with actual TP.HCM coordinates
        setTimeout(function() {
            // Demo route from District 1 to District 3 (may pass through hazard zones)
            const demoRoute = {
                distance_km: 5.2,
                duration_minutes: 15,
                route_points: [
                    [10.762622, 106.660172],  // Start: District 1
                    [10.768622, 106.665172],  // Middle point 1
                    [10.774622, 106.670172],  // Middle point 2 (near Nguyen Hue - hazard zone)
                    [10.780622, 106.675172],  // Middle point 3
                    [10.786622, 106.680172]   // End: District 3
                ],
                warnings: [
                    {type: 'traffic', message: 'T·∫Øc ƒë∆∞·ªùng nh·∫π tr√™n ƒë∆∞·ªùng Nguy·ªÖn Hu·ªá'},
                    {type: 'restricted', message: 'ƒê∆∞·ªùng L√™ L·ª£i ƒëang c·∫•m xe t·ª´ 7-9h s√°ng'}
                ]
            };
            
            currentRoutePoints = demoRoute.route_points;
            displayRoute(demoRoute);
            showNearbyVehicles(vehicleType);
            
            // Check for hazards
            checkRouteHazards(demoRoute.route_points);
        }, 1000);
    });
    
    function displayRoute(route) {
        document.getElementById('routeDistance').textContent = route.distance_km + ' km';
        document.getElementById('routeDuration').textContent = route.duration_minutes + ' ph√∫t';
        
        // Show warnings
        if (route.warnings && route.warnings.length > 0) {
            document.getElementById('routeWarnings').classList.remove('d-none');
            const warningsList = document.getElementById('warningsList');
            warningsList.innerHTML = '';
            
            route.warnings.forEach(warning => {
                const alertClass = warning.type === 'traffic' ? 'alert-warning' : 'alert-info';
                const icon = warning.type === 'traffic' ? 'fa-traffic-light' : 'fa-ban';
                warningsList.innerHTML += `
                    <div class="alert ${alertClass} small mb-2">
                        <i class="fas ${icon}"></i> ${warning.message}
                    </div>
                `;
            });
        }
        
        // Initialize map if not exists
        if (!map) {
            map = L.map('routeMap').setView([10.762622, 106.660172], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Load hazard zones
            loadHazardZones();
        }
        
        // Draw route using actual points
        const routePoints = route.route_points || [[10.762622, 106.660172], [10.782622, 106.680172]];
        
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }
        
        routeLayer = L.polyline(routePoints, {
            color: 'blue',
            weight: 4,
            opacity: 0.7
        }).addTo(map);
        
        // Add markers
        L.marker(routePoints[0]).addTo(map).bindPopup('ƒêi·ªÉm xu·∫•t ph√°t');
        L.marker(routePoints[routePoints.length - 1]).addTo(map).bindPopup('ƒêi·ªÉm ƒë·∫øn');
        
        map.fitBounds(routePoints, {padding: [50, 50]});
    }
    
    function showNearbyVehicles(vehicleType) {
        const container = document.getElementById('nearbyVehicles');
        container.innerHTML = '<div class="spinner-border spinner-border-sm"></div> ƒêang t√¨m xe...';
        
        // Demo vehicles
        setTimeout(function() {
            container.innerHTML = `
                <div class="list-group">
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="fas fa-bicycle text-success"></i> Honda Wave Alpha</h6>
                            <small class="text-muted">0.3 km</small>
                        </div>
                        <p class="mb-1 small">Bi·ªÉn s·ªë: 51F-12345 ‚Ä¢ Pin: 95%</p>
                        <small class="text-primary">500 VND/ph√∫t</small>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="fas fa-motorcycle text-info"></i> Yamaha Exciter</h6>
                            <small class="text-muted">0.5 km</small>
                        </div>
                        <p class="mb-1 small">Bi·ªÉn s·ªë: 51H-67890 ‚Ä¢ Pin: 87%</p>
                        <small class="text-primary">800 VND/ph√∫t</small>
                    </a>
                </div>
            `;
        }, 500);
    }
    
    // ==========================================
    // HAZARD ZONE FUNCTIONS (ITS Feature)
    // ==========================================
    
    function loadHazardZones() {
        // NOTE: Users don't have access to admin API
        // Hazard zones will be checked on backend when user plans route
        // No need to display zones on map for regular users
        console.log('‚ÑπÔ∏è Hazard zones will be checked when you plan a route');
        
        /* DISABLED - Admin API access required
        fetch('/admin/api/hazard-zones')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hazardZones = data.zones.filter(z => z.is_active);
                    displayHazardZonesOnMap(hazardZones);
                    console.log(`‚úÖ Loaded ${hazardZones.length} active hazard zones`);
                }
            })
            .catch(error => console.error('Error loading hazard zones:', error));
        */
    }
    
    function displayHazardZonesOnMap(zones) {
        zones.forEach(zone => {
            const polygon = L.polygon(zone.polygon_coordinates, {
                color: zone.color || '#ff0000',
                fillColor: zone.color || '#ff0000',
                fillOpacity: 0.2,
                weight: 2,
                className: 'hazard-zone-polygon'
            }).addTo(map);
            
            polygon.bindPopup(`
                <div class="text-center">
                    <strong class="text-danger">${zone.zone_name}</strong><br>
                    <span class="badge bg-${getSeverityBadgeClass(zone.severity)}">${zone.severity.toUpperCase()}</span><br>
                    <small class="text-muted">${zone.hazard_type}</small><br>
                    <small>${zone.warning_message || zone.description}</small>
                </div>
            `);
        });
    }
    
    let currentStartPoint = null;
    let currentEndPoint = null;
    let alternativeRoutesData = null;
    
    function checkRouteHazards(routePoints) {
        console.log('üîç Checking route for hazards...');
        
        // Store start/end for alternative routes
        if (routePoints.length >= 2) {
            currentStartPoint = routePoints[0];
            currentEndPoint = routePoints[routePoints.length - 1];
        }
        
        fetch('/trips/api/check-route-hazards', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                route_points: routePoints
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('üì• Hazard check result:', data);
            
            if (data.success && data.has_hazards) {
                showHazardWarning(data.hazards);
                // Auto-fetch alternative routes
                fetchAlternativeRoutes();
            } else {
                console.log('‚úÖ No hazards detected on route');
            }
        })
        .catch(error => {
            console.error('‚ùå Error checking hazards:', error);
        });
    }
    
    function showHazardWarning(hazards) {
        const hazardsList = document.getElementById('hazardsList');
        hazardsList.innerHTML = '';
        
        hazardsList.innerHTML += `
            <p class="text-muted mb-3">
                <i class="fas fa-info-circle"></i> 
                Tuy·∫øn ƒë∆∞·ªùng c·ªßa b·∫°n ƒëi qua <strong>${hazards.length}</strong> v√πng nguy hi·ªÉm:
            </p>
        `;
        
        hazards.forEach(hazard => {
            const severityClass = `hazard-${hazard.severity}`;
            hazardsList.innerHTML += `
                <div class="hazard-item ${severityClass}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">
                            <i class="fas ${hazard.type_icon}"></i> 
                            ${hazard.zone_name}
                        </h6>
                        <span class="badge bg-${getSeverityBadgeClass(hazard.severity)}">
                            ${hazard.severity.toUpperCase()}
                        </span>
                    </div>
                    <p class="mb-1 small">
                        <i class="fas fa-tag"></i> ${hazard.hazard_type}
                    </p>
                    <p class="mb-0">
                        <i class="fas ${hazard.severity_icon}"></i> 
                        ${hazard.warning_message || hazard.description}
                    </p>
                </div>
            `;
        });
        
        // Add alternative routes button
        hazardsList.innerHTML += `
            <div class="mt-3 p-3 bg-light rounded" id="alternativeRoutesSection">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin"></i> ƒêang t√≠nh to√°n ƒë∆∞·ªùng thay th·∫ø...
                </div>
            </div>
        `;
        
        // Show modal
        document.getElementById('hazardModal').classList.add('show');
    }
    
    function closeHazardModal() {
        document.getElementById('hazardModal').classList.remove('show');
    }
    
    function fetchAlternativeRoutes() {
        if (!currentStartPoint || !currentEndPoint) {
            console.error('Missing start/end points');
            return;
        }
        
        console.log('üîÑ Fetching alternative routes...');
        
        fetch('/trips/api/alternative-routes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                start_lat: currentStartPoint[0],
                start_lng: currentStartPoint[1],
                end_lat: currentEndPoint[0],
                end_lng: currentEndPoint[1]
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('üì• Alternative routes:', data);
            
            if (data.success) {
                alternativeRoutesData = data.routes;
                displayAlternativeRoutes(data.routes, data.has_safe_alternative);
            }
        })
        .catch(error => {
            console.error('‚ùå Error fetching alternative routes:', error);
            document.getElementById('alternativeRoutesSection').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Kh√¥ng th·ªÉ t√≠nh ƒë∆∞·ªùng thay th·∫ø
                </div>
            `;
        });
    }
    
    function displayAlternativeRoutes(routes, hasSafe) {
        const section = document.getElementById('alternativeRoutesSection');
        
        if (routes.length === 0) {
            section.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng thay th·∫ø
                </div>
            `;
            return;
        }
        
        let html = `
            <h6 class="mb-3">
                <i class="fas fa-map"></i> ƒê∆∞·ªùng thay th·∫ø 
                ${hasSafe ? '<span class="badge bg-success">C√≥ ƒë∆∞·ªùng an to√†n</span>' : ''}
            </h6>
        `;
        
        routes.forEach((route, index) => {
            const riskBadge = getRiskBadge(route.risk_level);
            const isRecommended = route.recommended;
            
            html += `
                <div class="card mb-2 ${isRecommended ? 'border-success' : ''}">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong>${route.route_name}</strong>
                                ${isRecommended ? '<span class="badge bg-success ms-2">ƒê·ªÅ xu·∫•t</span>' : ''}
                            </div>
                            ${riskBadge}
                        </div>
                        
                        <div class="row small text-muted">
                            <div class="col-4">
                                <i class="fas fa-route"></i> ${route.distance_km} km
                            </div>
                            <div class="col-4">
                                <i class="fas fa-clock"></i> ${route.estimated_time_minutes} ph√∫t
                            </div>
                            <div class="col-4">
                                <i class="fas fa-money-bill-wave"></i> ${route.estimated_cost_vnd.toLocaleString()} ƒë
                            </div>
                        </div>
                        
                        ${route.hazard_count > 0 ? `
                            <div class="mt-2">
                                <small class="text-danger">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    ${route.hazard_count} v√πng nguy hi·ªÉm
                                </small>
                            </div>
                        ` : `
                            <div class="mt-2">
                                <small class="text-success">
                                    <i class="fas fa-check-circle"></i> 
                                    An to√†n
                                </small>
                            </div>
                        `}
                        
                        <button class="btn btn-sm btn-outline-primary mt-2 w-100" 
                                onclick="selectRoute(${index})">
                            <i class="fas fa-check"></i> Ch·ªçn ƒë∆∞·ªùng n√†y
                        </button>
                    </div>
                </div>
            `;
        });
        
        section.innerHTML = html;
    }
    
    function getRiskBadge(riskLevel) {
        const badges = {
            'safe': '<span class="badge bg-success">An to√†n</span>',
            'low': '<span class="badge bg-info">R·ªßi ro th·∫•p</span>',
            'medium': '<span class="badge bg-warning">R·ªßi ro TB</span>',
            'high': '<span class="badge bg-danger">R·ªßi ro cao</span>',
            'critical': '<span class="badge bg-dark">R·∫•t nguy hi·ªÉm</span>'
        };
        return badges[riskLevel] || badges['medium'];
    }
    
    function selectRoute(routeIndex) {
        const route = alternativeRoutesData[routeIndex];
        console.log('‚úÖ Selected route:', route);
        
        // Clear existing route layers
        map.eachLayer(layer => {
            if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
                map.removeLayer(layer);
            }
        });
        
        // Draw selected route on map
        const routeCoords = route.path.map(p => [p.lat, p.lng]);
        const routeLine = L.polyline(routeCoords, {
            color: route.recommended ? '#28a745' : '#007bff',
            weight: 5,
            opacity: 0.8
        }).addTo(map);
        
        // Fit map to route
        map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
        
        // Close modal
        closeHazardModal();
        
        // Show success message
        alert(`‚úÖ ƒê√£ ch·ªçn: ${route.route_name}\n` +
              `üìç Kho·∫£ng c√°ch: ${route.distance_km} km\n` +
              `‚è±Ô∏è Th·ªùi gian: ${route.estimated_time_minutes} ph√∫t\n` +
              `üí∞ Chi ph√≠: ${route.estimated_cost_vnd.toLocaleString()} ƒë`);
    }
    
    function closeHazardModal() {
        document.getElementById('hazardModal').classList.remove('show');
    }
    
    function getSeverityBadgeClass(severity) {
        const classes = {
            'critical': 'danger',
            'high': 'warning',
            'medium': 'info',
            'low': 'secondary'
        };
        return classes[severity] || 'secondary';
    }
    
    // Close modal when clicking outside
    document.getElementById('hazardModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeHazardModal();
        }
    });
</script>
{% endblock %}
