{% extends 'base.html' %} {% block title %}L·∫≠p k·∫ø ho·∫°ch h√†nh tr√¨nh - SmartRent{%
endblock %} {% block extra_css %}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
/>
<style>
  .hazard-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .hazard-modal.show {
    display: flex;
  }

  .hazard-modal-content {
    background: white;
    border-radius: 12px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  }

  .hazard-item {
    border-left: 4px solid;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 4px;
    background: #f8f9fa;
  }

  .hazard-critical {
    border-color: #f44336;
    background: #ffebee;
  }
  .hazard-high {
    border-color: #ff5722;
    background: #fbe9e7;
  }
  .hazard-medium {
    border-color: #ff9800;
    background: #fff3e0;
  }
  .hazard-low {
    border-color: #ffc107;
    background: #fff8e1;
  }
</style>
{% endblock %} {% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="fas fa-route"></i> L·∫≠p k·∫ø ho·∫°ch h√†nh tr√¨nh
          </h4>
        </div>
        <div class="card-body">
          <form id="planTripForm">
            <div class="mb-3">
              <label for="startLocation" class="form-label">
                <i class="fas fa-map-marker-alt text-success"></i> ƒêi·ªÉm xu·∫•t
                ph√°t
              </label>
              <input
                type="text"
                class="form-control"
                id="startLocation"
                placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ xu·∫•t ph√°t"
                required
              />
            </div>

            <div class="mb-3">
              <label for="endLocation" class="form-label">
                <i class="fas fa-map-marker-alt text-danger"></i> ƒêi·ªÉm ƒë·∫øn
              </label>
              <input
                type="text"
                class="form-control"
                id="endLocation"
                placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒë·∫øn"
                required
              />
            </div>

            <div class="mb-3">
              <label for="vehicleType" class="form-label">
                <i class="fas fa-car"></i> Lo·∫°i ph∆∞∆°ng ti·ªán
              </label>
              <select class="form-select" id="vehicleType">
                <option value="all">T·∫•t c·∫£</option>
                <option value="motorbike">Xe m√°y</option>
                <option value="car">√î t√¥</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-search"></i> T√¨m l·ªô tr√¨nh
            </button>
          </form>

          <!-- Results -->
          <div id="routeResults" class="mt-4 d-none">
            <hr />
            <h5><i class="fas fa-info-circle"></i> Th√¥ng tin l·ªô tr√¨nh</h5>

            <div class="row mb-3">
              <div class="col-6">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h6 class="text-muted">Kho·∫£ng c√°ch</h6>
                    <h4 id="routeDistance">-</h4>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h6 class="text-muted">Th·ªùi gian</h6>
                    <h4 id="routeDuration">-</h4>
                  </div>
                </div>
              </div>
            </div>

            <!-- Warnings -->
            <div id="routeWarnings" class="d-none">
              <h6>
                <i class="fas fa-exclamation-triangle text-warning"></i> C·∫£nh
                b√°o
              </h6>
              <div id="warningsList"></div>
            </div>

            <!-- Map -->
            <div
              id="routeMap"
              style="height: 400px; border-radius: 8px"
              class="mt-3"
            ></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hazard Warning Modal -->
<div id="hazardModal" class="hazard-modal">
  <div class="hazard-modal-content">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">
        <i class="fas fa-exclamation-triangle text-warning"></i>
        C·∫£nh b√°o V√πng Nguy hi·ªÉm
      </h4>
      <button
        class="btn btn-sm btn-outline-secondary"
        onclick="closeHazardModal()"
      >
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div id="hazardsList"></div>

    <div class="mt-3 text-center">
      <button class="btn btn-warning" onclick="closeHazardModal()">
        <i class="fas fa-check"></i> T√¥i ƒë√£ hi·ªÉu
      </button>
      <button class="btn btn-outline-primary" onclick="closeHazardModal()">
        <i class="fas fa-route"></i> T√¨m ƒë∆∞·ªùng kh√°c
      </button>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
  let map;
  let routeLayer;
  let hazardZones = [];
  let currentRoutePoints = [];

  document
    .getElementById("planTripForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const startLocation = document.getElementById("startLocation").value;
      const endLocation = document.getElementById("endLocation").value;
      const vehicleType = document.getElementById("vehicleType").value;

      if (!startLocation || !endLocation) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß ƒëi·ªÉm xu·∫•t ph√°t v√† ƒëi·ªÉm ƒë·∫øn");
        return;
      }

      // Show loading
      document.getElementById("routeResults").classList.remove("d-none");
      document.getElementById("routeDistance").innerHTML =
        '<span class="spinner-border spinner-border-sm"></span> ƒêang t√≠nh...';
      document.getElementById("routeDuration").innerHTML =
        '<span class="spinner-border spinner-border-sm"></span> ƒêang t√≠nh...';

      // Geocode addresses and get route
      geocodeAndPlanRoute(startLocation, endLocation, vehicleType);
    });

  async function geocodeAndPlanRoute(startAddr, endAddr, vehicleType) {
    try {
      console.log("üîç Geocoding addresses...");

      // Geocode start address
      const startCoords = await geocodeAddress(startAddr);
      if (!startCoords) {
        alert("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ xu·∫•t ph√°t: " + startAddr);
        return;
      }

      // Geocode end address
      const endCoords = await geocodeAddress(endAddr);
      if (!endCoords) {
        alert("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ ƒë·∫øn: " + endAddr);
        return;
      }

      console.log(`üìç Start: ${startCoords.lat}, ${startCoords.lng}`);
      console.log(`üìç End: ${endCoords.lat}, ${endCoords.lng}`);

      // Call backend API to get optimized route
      const response = await fetch("/trips/api/optimize-route", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          start_lat: startCoords.lat,
          start_lng: startCoords.lng,
          end_lat: endCoords.lat,
          end_lng: endCoords.lng,
          start_address: startAddr, // For analytics
          end_address: endAddr, // For analytics
        }),
      });

      if (!response.ok) {
        throw new Error("API error: " + response.status);
      }

      const routeData = await response.json();
      console.log("‚úÖ Route data:", routeData);

      // Convert path to route_points format
      const route = {
        distance_km: routeData.distance_km,
        duration_minutes: routeData.estimated_time_minutes,
        route_points: routeData.path.map((p) => [p.lat, p.lng]),
        warnings: [],
      };

      currentRoutePoints = route.route_points;
      displayRoute(route);

      // Check for hazards
      checkRouteHazards(route.route_points);
    } catch (error) {
      console.error("‚ùå Error planning route:", error);
      alert("L·ªói khi t√≠nh to√°n l·ªô tr√¨nh. Vui l√≤ng th·ª≠ l·∫°i.");
      document.getElementById("routeDistance").textContent = "--";
      document.getElementById("routeDuration").textContent = "--";
    }
  }

  async function geocodeAddress(address) {
    try {
      // Use Nominatim API for geocoding (free)
      const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;

      const response = await fetch(url, {
        headers: {
          "User-Agent": "SmartRent-ITS/1.0",
        },
      });

      const data = await response.json();

      if (data.length === 0) {
        return null;
      }

      return {
        lat: parseFloat(data[0].lat),
        lng: parseFloat(data[0].lon),
      };
    } catch (error) {
      console.error("Geocoding error:", error);
      return null;
    }
  }

  function displayRoute(route) {
    document.getElementById("routeDistance").textContent =
      route.distance_km + " km";
    document.getElementById("routeDuration").textContent =
      route.duration_minutes + " ph√∫t";

    // Show warnings
    if (route.warnings && route.warnings.length > 0) {
      document.getElementById("routeWarnings").classList.remove("d-none");
      const warningsList = document.getElementById("warningsList");
      warningsList.innerHTML = "";

      route.warnings.forEach((warning) => {
        const alertClass =
          warning.type === "traffic" ? "alert-warning" : "alert-info";
        const icon = warning.type === "traffic" ? "fa-traffic-light" : "fa-ban";
        warningsList.innerHTML += `
                    <div class="alert ${alertClass} small mb-2">
                        <i class="fas ${icon}"></i> ${warning.message}
                    </div>
                `;
      });
    }

    // Initialize map if not exists
    if (!map) {
      map = L.map("routeMap").setView([10.762622, 106.660172], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap contributors",
      }).addTo(map);

      // Load hazard zones
      loadHazardZones();
    }

    // Draw route using actual points
    const routePoints = route.route_points || [
      [10.762622, 106.660172],
      [10.782622, 106.680172],
    ];

    if (routeLayer) {
      map.removeLayer(routeLayer);
    }

    routeLayer = L.polyline(routePoints, {
      color: "blue",
      weight: 4,
      opacity: 0.7,
    }).addTo(map);

    // Clear old markers
    if (window.startMarker) map.removeLayer(window.startMarker);
    if (window.endMarker) map.removeLayer(window.endMarker);

    // Create custom icons
    const startIcon = L.divIcon({
      html: '<div style="background-color: #28a745; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-play" style="color: white; font-size: 12px; margin-left: 2px;"></i></div>',
      className: "custom-start-marker",
      iconSize: [32, 32],
      iconAnchor: [16, 16],
    });

    const endIcon = L.divIcon({
      html: '<div style="background-color: #dc3545; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><i class="fas fa-flag-checkered" style="color: white; font-size: 12px;"></i></div>',
      className: "custom-end-marker",
      iconSize: [32, 32],
      iconAnchor: [16, 16],
    });

    // Add markers with custom icons
    window.startMarker = L.marker(routePoints[0], { icon: startIcon })
      .addTo(map)
      .bindPopup('<strong style="color: #28a745;">üöÄ ƒêi·ªÉm xu·∫•t ph√°t</strong>');

    window.endMarker = L.marker(routePoints[routePoints.length - 1], {
      icon: endIcon,
    })
      .addTo(map)
      .bindPopup('<strong style="color: #dc3545;">üèÅ ƒêi·ªÉm ƒë·∫øn</strong>');

    map.fitBounds(routePoints, { padding: [50, 50] });
  }

  // ==========================================
  // HAZARD ZONE FUNCTIONS (ITS Feature)
  // ==========================================

  function loadHazardZones() {
    // NOTE: Users don't have access to admin API
    // Hazard zones will be checked on backend when user plans route
    // No need to display zones on map for regular users
    console.log("‚ÑπÔ∏è Hazard zones will be checked when you plan a route");

    /* DISABLED - Admin API access required
        fetch('/admin/api/hazard-zones')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hazardZones = data.zones.filter(z => z.is_active);
                    displayHazardZonesOnMap(hazardZones);
                    console.log(`‚úÖ Loaded ${hazardZones.length} active hazard zones`);
                }
            })
            .catch(error => console.error('Error loading hazard zones:', error));
        */
  }

  function displayHazardZonesOnMap(zones) {
    zones.forEach((zone) => {
      const polygon = L.polygon(zone.polygon_coordinates, {
        color: zone.color || "#ff0000",
        fillColor: zone.color || "#ff0000",
        fillOpacity: 0.2,
        weight: 2,
        className: "hazard-zone-polygon",
      }).addTo(map);

      polygon.bindPopup(`
                <div class="text-center">
                    <strong class="text-danger">${zone.zone_name}</strong><br>
                    <span class="badge bg-${getSeverityBadgeClass(zone.severity)}">${zone.severity.toUpperCase()}</span><br>
                    <small class="text-muted">${zone.hazard_type}</small><br>
                    <small>${zone.warning_message || zone.description}</small>
                </div>
            `);
    });
  }

  let currentStartPoint = null;
  let currentEndPoint = null;
  let alternativeRoutesData = null;

  function checkRouteHazards(routePoints) {
    console.log("üîç Checking route for hazards...");

    // Store start/end for alternative routes
    if (routePoints.length >= 2) {
      currentStartPoint = routePoints[0];
      currentEndPoint = routePoints[routePoints.length - 1];
    }

    fetch("/trips/api/check-route-hazards", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        route_points: routePoints,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("üì• Hazard check result:", data);

        if (data.success && data.has_hazards) {
          showHazardWarning(data.hazards);
          // Auto-fetch alternative routes
          fetchAlternativeRoutes();
        } else {
          console.log("‚úÖ No hazards detected on route");
        }
      })
      .catch((error) => {
        console.error("‚ùå Error checking hazards:", error);
      });
  }

  function showHazardWarning(hazards) {
    const hazardsList = document.getElementById("hazardsList");
    hazardsList.innerHTML = "";

    hazardsList.innerHTML += `
            <p class="text-muted mb-3">
                <i class="fas fa-info-circle"></i> 
                Tuy·∫øn ƒë∆∞·ªùng c·ªßa b·∫°n ƒëi qua <strong>${hazards.length}</strong> v√πng nguy hi·ªÉm:
            </p>
        `;

    hazards.forEach((hazard) => {
      const severityClass = `hazard-${hazard.severity}`;
      hazardsList.innerHTML += `
                <div class="hazard-item ${severityClass}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">
                            <i class="fas ${hazard.type_icon}"></i> 
                            ${hazard.zone_name}
                        </h6>
                        <span class="badge bg-${getSeverityBadgeClass(hazard.severity)}">
                            ${hazard.severity.toUpperCase()}
                        </span>
                    </div>
                    <p class="mb-1 small">
                        <i class="fas fa-tag"></i> ${hazard.hazard_type}
                    </p>
                    <p class="mb-0">
                        <i class="fas ${hazard.severity_icon}"></i> 
                        ${hazard.warning_message || hazard.description}
                    </p>
                </div>
            `;
    });

    // Add alternative routes button
    hazardsList.innerHTML += `
            <div class="mt-3 p-3 bg-light rounded" id="alternativeRoutesSection">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin"></i> ƒêang t√≠nh to√°n ƒë∆∞·ªùng thay th·∫ø...
                </div>
            </div>
        `;

    // Show modal
    document.getElementById("hazardModal").classList.add("show");
  }

  function closeHazardModal() {
    document.getElementById("hazardModal").classList.remove("show");
  }

  function fetchAlternativeRoutes() {
    if (!currentStartPoint || !currentEndPoint) {
      console.error("Missing start/end points");
      return;
    }

    console.log("üîÑ Fetching alternative routes...");

    fetch("/trips/api/alternative-routes", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        start_lat: currentStartPoint[0],
        start_lng: currentStartPoint[1],
        end_lat: currentEndPoint[0],
        end_lng: currentEndPoint[1],
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("üì• Alternative routes:", data);

        if (data.success) {
          alternativeRoutesData = data.routes;
          displayAlternativeRoutes(data.routes, data.has_safe_alternative);
        }
      })
      .catch((error) => {
        console.error("‚ùå Error fetching alternative routes:", error);
        document.getElementById("alternativeRoutesSection").innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Kh√¥ng th·ªÉ t√≠nh ƒë∆∞·ªùng thay th·∫ø
                </div>
            `;
      });
  }

  function displayAlternativeRoutes(routes, hasSafe) {
    const section = document.getElementById("alternativeRoutesSection");

    if (routes.length === 0) {
      section.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng thay th·∫ø
                </div>
            `;
      return;
    }

    let html = `
            <h6 class="mb-3">
                <i class="fas fa-map"></i> ƒê∆∞·ªùng thay th·∫ø 
                ${hasSafe ? '<span class="badge bg-success">C√≥ ƒë∆∞·ªùng an to√†n</span>' : ""}
            </h6>
        `;

    routes.forEach((route, index) => {
      const riskBadge = getRiskBadge(route.risk_level);
      const isRecommended = route.recommended;

      html += `
                <div class="card mb-2 ${isRecommended ? "border-success" : ""}">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong>${route.route_name}</strong>
                                ${isRecommended ? '<span class="badge bg-success ms-2">ƒê·ªÅ xu·∫•t</span>' : ""}
                            </div>
                            ${riskBadge}
                        </div>
                        
                        <div class="row small text-muted">
                            <div class="col-4">
                                <i class="fas fa-route"></i> ${route.distance_km} km
                            </div>
                            <div class="col-4">
                                <i class="fas fa-clock"></i> ${route.estimated_time_minutes} ph√∫t
                            </div>
                            <div class="col-4">
                                <i class="fas fa-money-bill-wave"></i> ${route.estimated_cost_vnd.toLocaleString()} ƒë
                            </div>
                        </div>
                        
                        ${
                          route.hazard_count > 0
                            ? `
                            <div class="mt-2">
                                <small class="text-danger">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    ${route.hazard_count} v√πng nguy hi·ªÉm
                                </small>
                            </div>
                        `
                            : `
                            <div class="mt-2">
                                <small class="text-success">
                                    <i class="fas fa-check-circle"></i> 
                                    An to√†n
                                </small>
                            </div>
                        `
                        }
                        
                        <button class="btn btn-sm btn-outline-primary mt-2 w-100" 
                                onclick="selectRoute(${index})">
                            <i class="fas fa-check"></i> Ch·ªçn ƒë∆∞·ªùng n√†y
                        </button>
                    </div>
                </div>
            `;
    });

    section.innerHTML = html;
  }

  function getRiskBadge(riskLevel) {
    const badges = {
      safe: '<span class="badge bg-success">An to√†n</span>',
      low: '<span class="badge bg-info">R·ªßi ro th·∫•p</span>',
      medium: '<span class="badge bg-warning">R·ªßi ro TB</span>',
      high: '<span class="badge bg-danger">R·ªßi ro cao</span>',
      critical: '<span class="badge bg-dark">R·∫•t nguy hi·ªÉm</span>',
    };
    return badges[riskLevel] || badges["medium"];
  }

  function selectRoute(routeIndex) {
    const route = alternativeRoutesData[routeIndex];
    console.log("‚úÖ Selected route:", route);

    // Clear existing route layers
    map.eachLayer((layer) => {
      if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
        map.removeLayer(layer);
      }
    });

    // Draw selected route on map
    const routeCoords = route.path.map((p) => [p.lat, p.lng]);
    const routeLine = L.polyline(routeCoords, {
      color: route.recommended ? "#28a745" : "#007bff",
      weight: 5,
      opacity: 0.8,
    }).addTo(map);

    // Fit map to route
    map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });

    // Close modal
    closeHazardModal();

    // Show success message
    alert(
      `‚úÖ ƒê√£ ch·ªçn: ${route.route_name}\n` +
        `üìç Kho·∫£ng c√°ch: ${route.distance_km} km\n` +
        `‚è±Ô∏è Th·ªùi gian: ${route.estimated_time_minutes} ph√∫t\n` +
        `üí∞ Chi ph√≠: ${route.estimated_cost_vnd.toLocaleString()} ƒë`,
    );
  }

  function closeHazardModal() {
    document.getElementById("hazardModal").classList.remove("show");
  }

  function getSeverityBadgeClass(severity) {
    const classes = {
      critical: "danger",
      high: "warning",
      medium: "info",
      low: "secondary",
    };
    return classes[severity] || "secondary";
  }

  // Close modal when clicking outside
  document
    .getElementById("hazardModal")
    .addEventListener("click", function (e) {
      if (e.target === this) {
        closeHazardModal();
      }
    });
</script>
{% endblock %}
