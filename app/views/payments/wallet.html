{% extends "base.html" %} {% block title %}Ví điện tử - SmartRent{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2><i class="fas fa-wallet"></i> Ví điện tử</h2>
  <hr />

  <!-- Balance Card -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card bg-primary text-white">
        <div class="card-body text-center">
          <i class="fas fa-wallet fa-3x mb-3"></i>
          <h3>Số dư ví</h3>
          <h1 class="display-4" id="wallet-balance">
            {{ "{:,.0f}".format(balance) }} VND
          </h1>
          <button
            class="btn btn-light btn-lg mt-3"
            data-bs-toggle="modal"
            data-bs-target="#topupModal"
          >
            <i class="fas fa-plus-circle"></i> Nạp tiền
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Transaction History -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="fas fa-history"></i> Lịch sử giao dịch (20 giao dịch gần nhất)
      </h5>
    </div>
    <div class="card-body">
      {% if transactions %}
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Mã giao dịch</th>
              <th>Loại</th>
              <th>Số tiền</th>
              <th>Trạng thái</th>
              <th>Phương thức</th>
              <th>Thời gian</th>
            </tr>
          </thead>
          <tbody>
            {% for transaction in transactions %}
            <tr>
              <td><strong>{{ transaction.payment_code }}</strong></td>
              <td>
                {% if transaction.trip_id %}
                <span class="badge bg-danger">
                  <i class="fas fa-minus-circle"></i> Thanh toán chuyến đi
                </span>
                {% else %}
                <span class="badge bg-success">
                  <i class="fas fa-plus-circle"></i> Nạp tiền
                </span>
                {% endif %}
              </td>
              <td>
                {% if transaction.trip_id %}
                <span class="text-danger"
                  >-{{ "{:,.0f}".format(transaction.amount) }} VND</span
                >
                {% else %}
                <span class="text-success"
                  >+{{ "{:,.0f}".format(transaction.amount) }} VND</span
                >
                {% endif %}
              </td>
              <td>
                {% if transaction.payment_status == 'completed' %}
                <span class="badge bg-success">Hoàn thành</span>
                {% elif transaction.payment_status == 'pending' %}
                <span class="badge bg-warning">Đang xử lý</span>
                {% elif transaction.payment_status == 'failed' %}
                <span class="badge bg-danger">Thất bại</span>
                {% else %}
                <span class="badge bg-secondary"
                  >{{ transaction.payment_status }}</span
                >
                {% endif %}
              </td>
              <td>
                {% if transaction.payment_method == 'wallet' %}
                <i class="fas fa-wallet"></i> Ví {% elif
                transaction.payment_method == 'stripe' %}
                <i class="fab fa-stripe"></i> Stripe {% else %} {{
                transaction.payment_method }} {% endif %}
              </td>
              <td>
                {% if transaction.transaction_date %} {{
                transaction.transaction_date.strftime('%d/%m/%Y %H:%M') }} {%
                else %} {{ transaction.created_at.strftime('%d/%m/%Y %H:%M') }}
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center text-muted py-5">
        <i class="fas fa-inbox fa-3x mb-3"></i>
        <p>Chưa có giao dịch nào</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Top-up Modal -->
<div
  class="modal fade"
  id="topupModal"
  tabindex="-1"
  aria-labelledby="topupModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="topupModalLabel">
          <i class="fas fa-plus-circle"></i> Nạp tiền vào ví
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="topupForm">
          <div class="mb-3">
            <label for="amount" class="form-label">Số tiền (VND)</label>
            <input
              type="number"
              class="form-control"
              id="amount"
              name="amount"
              min="10000"
              step="1000"
              required
            />
            <div class="form-text">Số tiền tối thiểu: 10,000 VND</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Chọn mức nạp nhanh</label>
            <div class="d-grid gap-2">
              <button
                type="button"
                class="btn btn-outline-primary"
                onclick="setAmount(50000)"
              >
                50,000 VND
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                onclick="setAmount(100000)"
              >
                100,000 VND
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                onclick="setAmount(200000)"
              >
                200,000 VND
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                onclick="setAmount(500000)"
              >
                500,000 VND
              </button>
            </div>
          </div>
          <div class="mb-3">
            <label for="payment_method" class="form-label"
              >Phương thức thanh toán</label
            >
            <select
              class="form-select"
              id="payment_method"
              name="payment_method"
              required
            >
              <option value="stripe">Demo/Test (Miễn phí)</option>
            </select>
            <div class="form-text">
              <i class="fas fa-info-circle"></i> Đây là phiên bản demo, tiền sẽ
              được nạp trực tiếp vào ví
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Đóng
        </button>
        <button type="button" class="btn btn-primary" onclick="submitTopup()">
          <i class="fas fa-check"></i> Xác nhận nạp tiền
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  function setAmount(amount) {
    document.getElementById("amount").value = amount;
  }

  function submitTopup() {
    const amount = parseFloat(document.getElementById("amount").value);
    const payment_method = document.getElementById("payment_method").value;

    console.log("Submitting topup:", { amount, payment_method });

    if (!amount || amount < 10000) {
      alert("Vui lòng nhập số tiền hợp lệ (tối thiểu 10,000 VND)");
      return;
    }

    // Disable button to prevent double submission
    const submitBtn = event.target;
    submitBtn.disabled = true;
    submitBtn.innerHTML =
      '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

    fetch("/payments/topup", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        amount: amount,
        payment_method: payment_method,
      }),
    })
      .then((response) => {
        console.log("Response status:", response.status);
        if (!response.ok) {
          return response.json().then((err) => {
            throw new Error(err.error || "Server error");
          });
        }
        return response.json();
      })
      .then((data) => {
        console.log("Response data:", data);
        if (data.success) {
          // Update balance display
          document.getElementById("wallet-balance").textContent =
            new Intl.NumberFormat("vi-VN").format(data.new_balance) + " VND";

          // Show success message
          alert(data.message);

          // Close modal and reload page
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("topupModal")
          );
          if (modal) {
            modal.hide();
          }
          location.reload();
        } else {
          alert("Lỗi: " + (data.error || "Không thể nạp tiền"));
          submitBtn.disabled = false;
          submitBtn.innerHTML =
            '<i class="fas fa-check"></i> Xác nhận nạp tiền';
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Đã có lỗi xảy ra: " + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Xác nhận nạp tiền';
      });
  }
</script>
{% endblock %}
